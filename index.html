<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Couple Diary</title>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, onSnapshot, orderBy, query, doc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyBw9CXG7BMyCQ3qMWFaXPfi_gS_HIiXIOA",
  authDomain: "couple-diary-42d49.firebaseapp.com",
  projectId: "couple-diary-42d49",
  storageBucket: "couple-diary-42d49.firebasestorage.app",
  messagingSenderId: "162533479109",
  appId: "1:162533479109:web:a67f8d213bddafc66fd6ac",
  measurementId: "G-2N8R9H692D"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

let currentUser = null;

// üìÖ ÎÇ†Ïßú Ìè¨Îß∑
const fmt = ts => {
  if (!ts) return "";
  const d = ts.toDate();
  return `${d.getFullYear()}.${String(d.getMonth()+1).padStart(2,"0")}.${String(d.getDate()).padStart(2,"0")} ${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
};

// ‚úÖ Î°úÍ∑∏Ïù∏
function login(e){
  e.preventDefault();
  const id = document.getElementById("userid").value.trim();
  if(id==="SM0710") currentUser={name:"ÍπÄÏÜîÏùå", heart:"üñ§"};
  else if(id==="CY0710") currentUser={name:"ÏµúÏöîÏõê", heart:"üíô"};
  else return alert("Îì±Î°ùÎêòÏßÄ ÏïäÏùÄ ÏÇ¨Ïö©ÏûêÏûÖÎãàÎã§.");
  document.getElementById("login").style.display="none";
  document.getElementById("dashboard").style.display="block";
  document.getElementById("username").textContent=`${currentUser.name} ${currentUser.heart}`;
  loadAll();
}

// ‚úÖ Î°úÍ∑∏ÏïÑÏõÉ
function logout(){
  document.getElementById("dashboard").style.display="none";
  document.getElementById("login").style.display="flex";
  currentUser=null;
}

// ‚úÖ Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú
async function uploadPhoto(file){
  const storageRef = ref(storage, `photos/${Date.now()}_${file.name}`);
  await uploadBytes(storageRef, file);
  const url = await getDownloadURL(storageRef);
  await addDoc(collection(db,"photo"), {
    name: currentUser.name,
    url,
    timestamp: serverTimestamp()
  });
}

// ‚úÖ Î™®Îì† Îç∞Ïù¥ÌÑ∞ Î°úÎìú
function loadAll(){
  const todayBox = document.getElementById("todayLogs");
  const chatBox = document.getElementById("chatLogs");
  const photoBox = document.getElementById("photoBox");
  const musicList = document.getElementById("musicList");

  // üìù TodayLogs
  onSnapshot(query(collection(db,"todayLogs"), orderBy("timestamp","desc")), snap=>{
    todayBox.innerHTML="";
    snap.forEach(docSnap=>{
      const d=docSnap.data();
      const id=docSnap.id;
      const div=document.createElement("div");
      div.className="log";
      div.innerHTML=`
        <div class="meta">üìÖ ${d.date} ¬∑ ${d.updatedBy||"ÏùµÎ™Ö"} ¬∑ ${fmt(d.timestamp)}</div>
        <div class="text">${d.text}</div>
        ${currentUser.name===d.updatedBy?`
          <div class="actions">
            <button class="edit" data-id="${id}" data-type="today">ÏàòÏ†ï</button>
            <button class="del" data-id="${id}" data-type="today">ÏÇ≠Ï†ú</button>
          </div>`:""}
      `;
      todayBox.appendChild(div);
    });
  });

  // üí¨ Chat
  onSnapshot(query(collection(db,"chat"), orderBy("timestamp","asc")), snap=>{
    chatBox.innerHTML="";
    snap.forEach(docSnap=>{
      const d=docSnap.data();
      const id=docSnap.id;
      const div=document.createElement("div");
      div.className=`msg ${d.name===currentUser.name?"me":"you"}`;
      div.innerHTML=`
        <div class="bubble">
          <span>${d.message}</span>
          <div class="meta">${d.name} ¬∑ ${fmt(d.timestamp)}</div>
          ${d.name===currentUser.name?`
            <div class="actions">
              <button class="edit" data-id="${id}" data-type="chat">ÏàòÏ†ï</button>
              <button class="del" data-id="${id}" data-type="chat">ÏÇ≠Ï†ú</button>
            </div>`:""}
        </div>`;
      chatBox.appendChild(div);
    });
    chatBox.scrollTop=chatBox.scrollHeight;
  });

  // üì∏ Photo
  onSnapshot(query(collection(db,"photo"), orderBy("timestamp","desc")), snap=>{
    photoBox.innerHTML="";
    snap.forEach(docSnap=>{
      const d=docSnap.data();
      const img=document.createElement("img");
      img.src=d.url;
      img.alt=d.name;
      img.className="photo";
      photoBox.appendChild(img);
    });
  });

  // üéµ Playlist (Ïú†ÌäúÎ∏å Ï†úÎ™© ÏûêÎèô)
  onSnapshot(query(collection(db,"playlist"), orderBy("timestamp","desc")), snap=>{
    musicList.innerHTML="";
    snap.forEach(async docSnap=>{
      const d=docSnap.data();
      const id=docSnap.id;
      const match=d.url.match(/(?:v=|youtu\.be\/)([\w-]{11})/);
      const vid=match?match[1]:null;
      const thumb=vid?`https://img.youtube.com/vi/${vid}/hqdefault.jpg`:"";
      let title=d.title||"";
      if(!title && vid){
        try{
          const res=await fetch(`https://noembed.com/embed?url=https://www.youtube.com/watch?v=${vid}`);
          const info=await res.json();
          title=info.title||"YouTube Music";
        }catch{ title="YouTube Music"; }
      }

      const card=document.createElement("div");
      card.className="music-card";
      card.innerHTML=`
        <img src="${thumb}" class="thumb">
        <div class="info">
          <a href="${d.url}" target="_blank">${title}</a>
          <div class="meta">${d.addedBy} ¬∑ ${fmt(d.timestamp)}</div>
        </div>
        ${d.addedBy===currentUser.name?`
          <div class="actions">
            <button class="edit" data-id="${id}" data-type="music">ÏàòÏ†ï</button>
            <button class="del" data-id="${id}" data-type="music">ÏÇ≠Ï†ú</button>
          </div>`:""}
      `;
      musicList.appendChild(card);
    });
  });
}

// ‚úÖ ÏóîÌÑ∞ ÏûÖÎ†•
window.addEventListener("keypress",e=>{
  if(e.key==="Enter"){
    if(document.activeElement.id==="chatInput") sendChat();
    if(document.activeElement.id==="todayInput") addTodayLog();
    if(document.activeElement.id==="musicUrl") addMusic();
  }
});

// ‚úÖ Ìà¨Îç∞Ïù¥ Î°úÍ∑∏ Ï∂îÍ∞Ä
async function addTodayLog(){
  const text=document.getElementById("todayInput").value.trim();
  if(!text) return;
  await addDoc(collection(db,"todayLogs"),{
    date:new Date().toLocaleDateString("ko-KR"),
    text,
    timestamp:serverTimestamp(),
    updatedBy:currentUser.name
  });
  document.getElementById("todayInput").value="";
}

// ‚úÖ Ï±ÑÌåÖ Î≥¥ÎÇ¥Í∏∞
async function sendChat(){
  const msg=document.getElementById("chatInput").value.trim();
  if(!msg) return;
  await addDoc(collection(db,"chat"),{
    message:msg,
    name:currentUser.name,
    heart:currentUser.heart,
    timestamp:serverTimestamp()
  });
  document.getElementById("chatInput").value="";
}

// ‚úÖ ÏùåÏïÖ Ï∂îÍ∞Ä
async function addMusic(){
  const url=document.getElementById("musicUrl").value.trim();
  if(!url) return;
  await addDoc(collection(db,"playlist"),{
    url,
    addedBy:currentUser.name,
    timestamp:serverTimestamp()
  });
  document.getElementById("musicUrl").value="";
}

// ‚úÖ Ïù¥Î≤§Ìä∏ ÏúÑÏûÑ
document.addEventListener("click",async e=>{
  const type=e.target.dataset.type;
  const id=e.target.dataset.id;
  if(!type||!id) return;
  const ref=doc(db,type==="today"? "todayLogs" : type==="chat"?"chat":"playlist", id);
  
  if(e.target.classList.contains("del")){
    if(confirm("Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†Ïñ¥Ïöî?")) await deleteDoc(ref);
  }
  if(e.target.classList.contains("edit")){
    const newText=prompt("ÏàòÏ†ïÌï† ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:");
    if(newText){
      if(type==="music") await updateDoc(ref,{url:newText});
      else if(type==="today") await updateDoc(ref,{text:newText, updatedBy:currentUser.name, timestamp:serverTimestamp()});
      else await updateDoc(ref,{message:newText});
    }
  }
});

// ‚úÖ ÌååÏùº ÏóÖÎ°úÎìú
document.getElementById("photoUpload").addEventListener("change",e=>{
  const file=e.target.files[0];
  if(file) uploadPhoto(file);
});

document.getElementById("loginForm").addEventListener("submit",login);
document.getElementById("logoutBtn").addEventListener("click",logout);
document.getElementById("addTodayBtn").addEventListener("click",addTodayLog);
document.getElementById("sendChatBtn").addEventListener("click",sendChat);
document.getElementById("addMusicBtn").addEventListener("click",addMusic);
</script>

<style>
body{
  margin:0;font-family:"Pretendard",sans-serif;background:#f2f4f6;color:#333;
}
#login{display:flex;align-items:center;justify-content:center;height:100vh;background:#f4f6f9;}
.login-box{padding:40px 50px;border-radius:20px;box-shadow:inset 4px 4px 8px #d9d9d9,inset -4px -4px 8px #fff;background:#f4f6f9;text-align:center;}
.login-box input{padding:10px 15px;border:none;border-radius:12px;box-shadow:inset 3px 3px 6px #dcdcdc,inset -3px -3px 6px #fff;background:#f4f6f9;margin-bottom:20px;width:200px;}
.login-box button{background:#5a6c85;color:#fff;padding:10px 20px;border:none;border-radius:12px;cursor:pointer;}

#dashboard{display:none;min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:20px;}
.top-bar{width:100%;display:flex;justify-content:flex-end;padding:10px 20px;font-weight:600;}
.container{display:flex;gap:20px;justify-content:center;align-items:flex-start;flex-wrap:wrap;width:100%;max-width:1200px;}
.section{background:#f4f6f9;border-radius:20px;padding:20px;box-shadow:8px 8px 16px #dcdcdc,-8px -8px 16px #fff;flex:1;min-width:300px;}

#photoBox img{width:100%;border-radius:20px;object-fit:cover;max-height:400px;}
.log{background:#fff;border-radius:15px;padding:10px;margin-bottom:10px;box-shadow:2px 2px 6px #ddd;}
.msg{margin:8px 0;}
.msg.me .bubble{background:#dce8ff;margin-left:auto;}
.msg.you .bubble{background:#fff0f3;}
.bubble{border-radius:15px;padding:10px;max-width:80%;box-shadow:2px 2px 6px #ddd;}
.actions{text-align:right;margin-top:4px;}
.actions button{font-size:11px;background:none;border:none;color:#888;cursor:pointer;}

#musicList{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;margin-top:20px;}
.music-card{background:#fff;border-radius:15px;box-shadow:2px 2px 6px #ddd;padding:10px;display:flex;flex-direction:column;align-items:center;transition:0.2s;}
.music-card:hover{transform:translateY(-2px);}
.thumb{width:100%;border-radius:12px;margin-bottom:8px;}
.info a{font-weight:600;color:#333;text-decoration:none;}
.meta{font-size:11px;color:#777;}
</style>
</head>
<body>
<div id="login">
  <form id="loginForm" class="login-box">
    <h2>üíå</h2>
    <input id="userid" placeholder="IDÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî" />
    <button type="submit">Î°úÍ∑∏Ïù∏</button>
  </form>
</div>

<div id="dashboard">
  <div class="top-bar">
    <span id="username"></span>
    <button id="logoutBtn" style="margin-left:10px;">Î°úÍ∑∏ÏïÑÏõÉ</button>
  </div>

  <div class="container">
    <div class="section">
      <h3>Ìà¨Îç∞Ïù¥ Î°úÍ∑∏</h3>
      <textarea id="todayInput" placeholder="Ïò§ÎäòÏùò Í∏∞Î°ùÏùÑ ÎÇ®Í≤®Ïöî" style="width:100%;height:80px;border:none;border-radius:12px;padding:10px;"></textarea>
      <button id="addTodayBtn">Ï∂îÍ∞Ä</button>
      <div id="todayLogs"></div>
    </div>

    <div class="section" id="photoSection">
      <h3>ÏÇ¨ÏßÑ</h3>
      <input type="file" id="photoUpload" accept="image/*" />
      <div id="photoBox"></div>
    </div>

    <div class="section">
      <h3>Ï±ÑÌåÖ Î°úÍ∑∏</h3>
      <div id="chatLogs" style="height:300px;overflow-y:auto;background:#fff;border-radius:15px;padding:10px;margin-bottom:10px;"></div>
      <input id="chatInput" placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî" style="width:80%;border:none;border-radius:12px;padding:8px;" />
      <button id="sendChatBtn">Î≥¥ÎÇ¥Í∏∞</button>
    </div>
  </div>

  <div class="section" style="width:90%;margin-top:20px;">
    <h3>üé∂ ÌîåÎ†àÏù¥Î¶¨Ïä§Ìä∏</h3>
    <input id="musicUrl" placeholder="YouTube ÎßÅÌÅ¨ ÏûÖÎ†•" style="width:80%;border:none;border-radius:12px;padding:8px;" />
    <button id="addMusicBtn">Ï∂îÍ∞Ä</button>
    <div id="musicList"></div>
  </div>
</div>
</body>
</html>
