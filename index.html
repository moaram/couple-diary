<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Couple Space ✿</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --bg: #f4f6f8;
      --panel: #ffffff;
      --accent1: #c7d8e6;
      --accent2: #b1c8db;
      --text: #3b3b3b;
      --muted: #9b9b9b;
    }

    body {
      background: linear-gradient(145deg, #f3f5f7, #f8f9fa);
      font-family: "Pretendard", "Noto Sans KR", sans-serif;
      color: var(--text);
      margin: 0;
      height: 100vh;
      overflow: hidden;
    }

    .soft {
      background: var(--panel);
      border-radius: 18px;
      box-shadow: 6px 6px 12px #dfe3e8, -6px -6px 12px #ffffff;
      padding: 16px;
    }

    .btn {
      background: linear-gradient(145deg, var(--accent1), var(--accent2));
      color: white;
      font-weight: 600;
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      cursor: pointer;
      white-space: nowrap;
    }

    .btn:active {
      transform: scale(0.98);
    }

    input, textarea {
      width: 100%;
      border: none;
      border-radius: 12px;
      background: #f1f3f5;
      padding: 10px;
      box-shadow: inset 3px 3px 6px #d9d9d9, inset -3px -3px 6px #ffffff;
      font-size: 14px;
      color: var(--text);
      resize: none;
    }

    .container {
      display: grid;
      grid-template-columns: 1fr 1.2fr 1fr;
      gap: 16px;
      height: calc(100vh - 80px);
    }

    .panel {
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .list {
      overflow-y: auto;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .item {
      background: #f9fafb;
      border-radius: 12px;
      padding: 10px;
      box-shadow: inset 2px 2px 5px #e0e0e0, inset -2px -2px 5px #fff;
    }

    .meta {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }

    .chat-box {
      overflow-y: auto;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .bubble {
      max-width: 80%;
      padding: 8px 12px;
      border-radius: 16px;
      word-break: break-word;
      font-size: 14px;
      box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.05);
    }

    .me {
      align-self: flex-end;
      background: #d0e6f5;
    }

    .other {
      align-self: flex-start;
      background: #f0f5fa;
    }

    #photo-display {
      width: 100%;
      border-radius: 12px;
      object-fit: cover;
      max-height: 420px;
      background: #f5f5f5;
    }

    #playlist {
      margin-top: 14px;
    }

    @media (max-width: 960px) {
      .container {
        grid-template-columns: 1fr;
        height: auto;
      }
    }
  </style>
</head>
<body class="p-6">
  <div id="login" class="soft mx-auto max-w-sm mt-24 text-center">
    <h1 class="font-bold text-lg mb-4 text-gray-700">💙 Couple Space</h1>
    <input id="loginId" placeholder="아이디 입력 (SM0710 / CY0710)" class="mb-3 text-center" />
    <button id="loginBtn" class="btn w-full">로그인</button>
  </div>

  <div id="main" style="display:none;">
    <div class="flex justify-end mb-3">
      <span id="userName" class="font-semibold mr-3"></span>
      <button id="logout" class="btn px-4 py-1">로그아웃</button>
    </div>

    <div class="container">
      <!-- Today Log -->
      <div class="soft panel">
        <h2 class="font-semibold mb-2">📔 Today Log</h2>
        <textarea id="todayInput" placeholder="오늘의 기록을 남겨보세요."></textarea>
        <button id="todaySave" class="btn mt-2">저장</button>
        <div id="todayList" class="list mt-3"></div>
      </div>

      <!-- Photo + Playlist -->
      <div class="soft panel items-center">
        <h2 class="font-semibold mb-2">📸 Photo</h2>
        <img id="photo-display" src="" alt="photo" />
        <input type="file" id="photo-upload" accept="image/*" class="mt-3" />
        <div class="meta text-center mt-1">사진은 자동으로 저장됩니다.</div>

        <div id="playlist" class="mt-6 w-full">
          <h2 class="font-semibold mb-2">🎵 Playlist</h2>
          <div class="flex gap-2">
            <input id="musicLink" placeholder="YouTube 링크 입력" />
            <button id="musicAdd" class="btn">추가</button>
          </div>
          <div id="musicList" class="list mt-3"></div>
        </div>
      </div>

      <!-- Chat -->
      <div class="soft panel">
        <h2 class="font-semibold mb-2">💬 Chat</h2>
        <div id="chatBox" class="chat-box"></div>
        <div class="flex gap-2 mt-2">
          <input id="chatInput" placeholder="메시지를 입력하세요" />
          <button id="chatSend" class="btn">보내기</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore, collection, addDoc, onSnapshot, query, orderBy,
      serverTimestamp, updateDoc, deleteDoc, doc, getDoc
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBw9CXG7BMyCQ3qMWFaXPfi_gS_HIiXIOA",
      authDomain: "couple-diary-42d49.firebaseapp.com",
      projectId: "couple-diary-42d49",
      storageBucket: "couple-diary-42d49.firebasestorage.app",
      messagingSenderId: "162533479109",
      appId: "1:162533479109:web:a67f8d213bddafc66fd6ac",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const login = document.getElementById("login");
    const main = document.getElementById("main");
    const loginBtn = document.getElementById("loginBtn");
    const loginId = document.getElementById("loginId");
    const logout = document.getElementById("logout");
    const userName = document.getElementById("userName");

    const todayInput = document.getElementById("todayInput");
    const todaySave = document.getElementById("todaySave");
    const todayList = document.getElementById("todayList");
    const chatBox = document.getElementById("chatBox");
    const chatInput = document.getElementById("chatInput");
    const chatSend = document.getElementById("chatSend");
    const photoUpload = document.getElementById("photo-upload");
    const photoDisplay = document.getElementById("photo-display");
    const musicLink = document.getElementById("musicLink");
    const musicAdd = document.getElementById("musicAdd");
    const musicList = document.getElementById("musicList");

    let currentUser = null;

    function fmt(ts) {
      if (!ts) return "";
      const d = ts.toDate();
      return `${d.getFullYear()}.${(d.getMonth()+1)
        .toString().padStart(2,"0")}.${d.getDate()
        .toString().padStart(2,"0")} ${d.getHours()
        .toString().padStart(2,"0")}:${d.getMinutes()
        .toString().padStart(2,"0")}`;
    }

    loginBtn.addEventListener("click", () => {
      const id = loginId.value.trim();
      if (id === "SM0710") currentUser = { name: "김솔음", heart: "💙" };
      else if (id === "CY0710") currentUser = { name: "최요원", heart: "💛" };
      else return alert("아이디가 올바르지 않습니다.");

      login.style.display = "none";
      main.style.display = "block";
      userName.textContent = `${currentUser.heart} ${currentUser.name}`;

      subscribeData();
    });

    logout.addEventListener("click", () => location.reload());

    function subscribeData() {
      // Today Logs
      onSnapshot(query(collection(db, "todayLogs"), orderBy("timestamp", "desc")), snap => {
        todayList.innerHTML = "";
        snap.forEach(docSnap => {
          const d = docSnap.data();
          const id = docSnap.id;
          const item = document.createElement("div");
          item.className = "item";
          item.innerHTML = `
            <div><b>${d.updatedBy}</b> — ${d.text}</div>
            <div class="meta">${d.date || fmt(d.timestamp)}</div>
            ${d.updatedBy === currentUser.name ? `
              <div class="flex gap-2 mt-1">
                <button class="btn text-xs px-2 py-1" data-id="${id}" data-type="edit-today">수정</button>
                <button class="btn text-xs px-2 py-1" data-id="${id}" data-type="del-today">삭제</button>
              </div>` : ""}
          `;
          todayList.appendChild(item);
        });
      });

      // Chat
      onSnapshot(query(collection(db, "chat"), orderBy("timestamp", "asc")), snap => {
        chatBox.innerHTML = "";
        snap.forEach(docSnap => {
          const d = docSnap.data();
          const bubble = document.createElement("div");
          bubble.className = "bubble " + (d.name === currentUser.name ? "me" : "other");
          bubble.innerHTML = `${d.message}<div class="meta">${d.name} · ${fmt(d.timestamp)}</div>`;
          chatBox.appendChild(bubble);
        });
        chatBox.scrollTop = chatBox.scrollHeight;
      });

      // Photo
      onSnapshot(query(collection(db, "photo"), orderBy("timestamp", "desc")), snap => {
        if (!snap.empty) {
          const url = snap.docs[0].data().url;
          photoDisplay.src = url;
        }
      });

      // Playlist
      onSnapshot(query(collection(db, "playlist"), orderBy("timestamp", "desc")), snap => {
        musicList.innerHTML = "";
        snap.forEach(docSnap => {
          const d = docSnap.data();
          const id = docSnap.id;
          const card = document.createElement("div");
          card.className = "item";
          card.innerHTML = `
            <div>${d.url}</div>
            <div class="meta">${d.addedBy} · ${fmt(d.timestamp)}</div>
            ${d.addedBy === currentUser.name ? `
              <div class="flex gap-2 mt-1">
                <button class="btn text-xs px-2 py-1" data-id="${id}" data-type="edit-music">수정</button>
                <button class="btn text-xs px-2 py-1" data-id="${id}" data-type="del-music">삭제</button>
              </div>` : ""}
          `;
          musicList.appendChild(card);
        });
      });
    }

    // Save Today
    todaySave.addEventListener("click", async () => {
      const text = todayInput.value.trim();
      if (!text) return;
      await addDoc(collection(db, "todayLogs"), {
        text,
        updatedBy: currentUser.name,
        date: new Date().toISOString().slice(0, 10).replace(/-/g, "."),
        timestamp: serverTimestamp(),
      });
      todayInput.value = "";
    });

    // Chat send
    const sendChat = async () => {
      const msg = chatInput.value.trim();
      if (!msg) return;
      await addDoc(collection(db, "chat"), {
        name: currentUser.name,
        message: msg,
        timestamp: serverTimestamp(),
      });
      chatInput.value = "";
    };
    chatSend.addEventListener("click", sendChat);
    chatInput.addEventListener("keypress", e => { if (e.key === "Enter") sendChat(); });

    // Photo upload
    photoUpload.addEventListener("change", async e => {
      const file = e.target.files[0];
      if (!file) return;
      const path = `photos/${Date.now()}_${file.name}`;
      const storageRef = ref(storage, path);
      await uploadBytes(storageRef, file);
      const url = await getDownloadURL(storageRef);
      await addDoc(collection(db, "photo"), {
        url,
        uploadedBy: currentUser.name,
        timestamp: serverTimestamp(),
      });
    });

    // Playlist add
    musicAdd.addEventListener("click", async () => {
      const url = musicLink.value.trim();
      if (!url) return;
      await addDoc(collection(db, "playlist"), {
        url,
        addedBy: currentUser.name,
        timestamp: serverTimestamp(),
      });
      musicLink.value = "";
    });

    // Edit/Delete delegation
    document.body.addEventListener("click", async e => {
      const t = e.target.dataset.type;
      const id = e.target.dataset.id;
      if (!t || !id) return;
      if (t === "del-today") {
        if (confirm("정말 삭제할까요?")) await deleteDoc(doc(db, "todayLogs", id));
      }
      if (t === "edit-today") {
        const ref = doc(db, "todayLogs", id);
        const snap = await getDoc(ref);
        const newText = prompt("수정할 내용을 입력하세요", snap.data().text);
        if (newText !== null)
          await updateDoc(ref, { text: newText, updatedBy: currentUser.name, timestamp: serverTimestamp() });
      }
      if (t === "del-music") {
        if (confirm("정말 삭제할까요?")) await deleteDoc(doc(db, "playlist", id));
      }
      if (t === "edit-music") {
        const ref = doc(db, "playlist", id);
        const snap = await getDoc(ref);
        const newLink = prompt("새 링크를 입력하세요", snap.data().url);
        if (newLink !== null)
          await updateDoc(ref, { url: newLink, addedBy: currentUser.name, timestamp: serverTimestamp() });
      }
    });
  </script>
</body>
</html>
