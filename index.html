<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Couple Space ‚Äî Soft Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* üå´Ô∏è Soft Blue Gray Theme */
    :root {
      --base: #eef1f4;
      --card: #e0e5eb;
      --shadow-dark: #c5ccd3;
      --shadow-light: #f5f8fb;
      --accent: #7ea3c5;
      --button: #a7b9c9;
      --button-hover: #90a8ba;
      --text: #2e2e2e;
      --success: #b6d7b9;
      --delete: #e6b5b5;
    }

    html, body {
      height: 100%;
      background: var(--base);
      color: var(--text);
      font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
      transition: all 0.3s ease;
    }

    /* Î°úÍ∑∏Ïù∏ */
    #login-section {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    .login-card {
      background: var(--card);
      border-radius: 25px;
      box-shadow: 9px 9px 18px var(--shadow-dark),
                  -9px -9px 18px var(--shadow-light);
      padding: 2.5rem;
      text-align: center;
      width: 320px;
      transition: 0.4s ease;
    }

    .login-card input {
      background: #e4e9ee;
      border: none;
      border-radius: 14px;
      padding: 10px;
      width: 100%;
      box-shadow: inset 3px 3px 6px var(--shadow-dark),
                  inset -3px -3px 6px var(--shadow-light);
      font-size: 0.95rem;
      outline: none;
      margin-top: 1rem;
    }

    .login-card button {
      margin-top: 1.5rem;
      background: var(--button);
      color: white;
      border: none;
      border-radius: 14px;
      padding: 10px 0;
      width: 100%;
      font-size: 1rem;
      cursor: pointer;
      box-shadow: 5px 5px 10px var(--shadow-dark),
                  -5px -5px 10px var(--shadow-light);
      transition: 0.3s ease;
    }
    .login-card button:hover { background: var(--button-hover); box-shadow: 0 0 10px rgba(126,163,197,0.5); }

    .heart { font-size: 2.2rem; color: var(--accent); animation: heartPop 1s ease-out; }
    @keyframes heartPop {
      0% { transform: scale(0); opacity: 0; }
      70% { transform: scale(1.2); opacity: 1; }
      100% { transform: scale(1); }
    }

    /* ÎåÄÏãúÎ≥¥Îìú */
    #dashboard { display: none; flex-direction: column; gap: 1rem; padding: 1.5rem; max-width: 1280px; margin: 0 auto; }
    header { display: flex; justify-content: flex-end; align-items: center; gap: 0.5rem; }
    #userDisplay { font-weight: 600; color: var(--accent); font-size: 1rem; }
    .logout-btn { background: transparent; border: none; color: var(--text); cursor: pointer; opacity: 0.7; transition: 0.3s; }
    .logout-btn:hover { opacity: 1; text-shadow: 0 0 6px rgba(126,163,197,0.5); }

    .panel {
      background: var(--card);
      border-radius: 20px;
      box-shadow: 9px 9px 18px var(--shadow-dark),
                  -9px -9px 18px var(--shadow-light);
      padding: 1.2rem;
      flex: 1;
      animation: fadeIn 0.5s ease;
    }

    h2 { color: var(--accent); font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem; }

    textarea, input[type="text"] {
      background: #e4e9ee;
      border: none;
      border-radius: 12px;
      width: 100%;
      padding: 8px;
      font-size: 0.9rem;
      box-shadow: inset 3px 3px 6px var(--shadow-dark),
                  inset -3px -3px 6px var(--shadow-light);
      outline: none;
    }

    button.primary {
      background: var(--button);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 8px 14px;
      font-weight: 600;
      cursor: pointer;
      transition: 0.3s;
      box-shadow: 5px 5px 10px var(--shadow-dark),
                  -5px -5px 10px var(--shadow-light);
    }
    button.primary:hover {
      background: var(--button-hover);
      box-shadow: 0 0 10px rgba(126,163,197,0.5);
    }

    .layout-row { display: flex; gap: 1rem; flex-wrap: wrap; }
    .left, .center, .right { flex: 1; min-width: 280px; display: flex; flex-direction: column; gap: 0.5rem; }

    .photo-box img {
      width: 100%;
      border-radius: 12px;
      object-fit: cover;
      max-height: 480px;
      animation: fadeIn 1s ease;
    }

    /* üéµ Playlist */
    .playlist { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; }
    .playlist-item {
      background: var(--card);
      border-radius: 16px;
      box-shadow: 6px 6px 12px var(--shadow-dark),
                  -6px -6px 12px var(--shadow-light);
      padding: 0.8rem;
      text-align: center;
      transition: 0.3s;
      animation: fadeIn 0.6s ease;
    }
    .playlist-item:hover { transform: translateY(-3px); box-shadow: 0 0 10px rgba(126,163,197,0.4); }

    /* üí¨ Chat Ïä§ÌÉÄÏùº */
    .chat-message {
      max-width: 70%;
      padding: 10px 14px;
      border-radius: 18px;
      box-shadow: 3px 3px 6px var(--shadow-dark),
                  -3px -3px 6px var(--shadow-light);
      word-break: break-word;
      opacity: 0;
      animation: fadeInUp 0.4s forwards;
    }

    .chat-me {
      align-self: flex-end;
      background: linear-gradient(135deg, var(--accent), #a8bed4);
      color: white;
      border-bottom-right-radius: 4px;
    }
    .chat-other {
      align-self: flex-start;
      background: linear-gradient(135deg, #dee3e9, #f3f6f8);
      color: var(--text);
      border-bottom-left-radius: 4px;
    }

    .edit-btn, .del-btn {
      background: none;
      border: none;
      font-size: 0.8rem;
      cursor: pointer;
      opacity: 0.6;
      transition: 0.2s;
    }
    .edit-btn:hover, .del-btn:hover {
      opacity: 1;
      text-decoration: underline;
      text-shadow: 0 0 6px rgba(126,163,197,0.4);
    }

    /* ‚ú® ÏïåÎ¶º */
    #alertBox {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: var(--card);
      padding: 12px 20px;
      border-radius: 12px;
      box-shadow: 6px 6px 12px var(--shadow-dark),
                  -6px -6px 12px var(--shadow-light);
      display: none;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes fadeInUp { from { transform: translateY(8px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    @media (max-width: 768px) {
      .layout-row { flex-direction: column; }
      .chat-message { max-width: 85%; }
    }
  </style>
</head>
<body>

  <!-- ‚ú® ÏïåÎ¶º -->
  <div id="alertBox"></div>

  <!-- Î°úÍ∑∏Ïù∏ -->
  <section id="login-section">
    <div class="login-card">
      <div class="heart mb-3">üíô</div>
      <h2>Login</h2>
      <input id="login-id" placeholder="ID ÏûÖÎ†• (SM0710 / CY0710)" />
      <button id="login-btn">Login</button>
    </div>
  </section>

  <!-- ÎåÄÏãúÎ≥¥Îìú -->
  <main id="dashboard">
    <header>
      <span id="userDisplay"></span>
      <button class="logout-btn" id="logoutBtn">Logout</button>
    </header>

    <div class="layout-row">
      <section class="panel left">
        <h2>üñ§ Today Log</h2>
        <textarea id="today-text" placeholder="Ïò§Îäò ÌïòÎ£®Î•º Í∏∞Î°ùÌïòÏÑ∏Ïöî..."></textarea>
        <button class="primary" id="today-save">Ï†ÄÏû•</button>
        <div id="today-list" class="mt-2 space-y-2"></div>
      </section>

      <section class="panel center">
        <h2>üì∏ Couple Photo</h2>
        <input type="file" id="photo-upload" accept="image/*" class="mt-2" />
        <div class="photo-box mt-2"><img id="photo-display" src="" alt="couple"></div>
      </section>

      <section class="panel right">
        <h2>üí¨ Chat Log</h2>
        <div id="chat-box" class="overflow-auto flex flex-col gap-2 h-[350px] bg-[#e8edf2] rounded-xl p-2"></div>
        <input id="chat-input" type="text" placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî" />
        <button class="primary mt-1" id="send-btn">Î≥¥ÎÇ¥Í∏∞</button>
      </section>
    </div>

    <section class="panel">
      <h2>üéµ Playlist</h2>
      <div class="flex gap-2 mt-2">
        <input id="music-link" placeholder="YouTube ÎßÅÌÅ¨ ÏûÖÎ†•" type="text" class="flex-1" />
        <button id="music-add" class="primary">Ï∂îÍ∞Ä</button>
      </div>
      <div id="music-list" class="playlist mt-3"></div>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp,
      updateDoc, doc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBw9CXG7BMyCQ3qMWFaXPfi_gS_HIiXIOA",
      authDomain: "couple-diary-42d49.firebaseapp.com",
      projectId: "couple-diary-42d49",
      storageBucket: "couple-diary-42d49.firebasestorage.app",
      messagingSenderId: "162533479109",
      appId: "1:162533479109:web:a67f8d213bddafc66fd6ac"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    // ‚öôÔ∏è DOM
    const loginSection = document.getElementById("login-section");
    const dashboard = document.getElementById("dashboard");
    const loginBtn = document.getElementById("login-btn");
    const loginId = document.getElementById("login-id");
    const userDisplay = document.getElementById("userDisplay");
    const logoutBtn = document.getElementById("logoutBtn");
    const alertBox = document.getElementById("alertBox");

    let currentUser = null;

    // ‚ú® ÏïåÎ¶º Ìï®Ïàò
    function showAlert(msg) {
      alertBox.textContent = msg;
      alertBox.style.display = "block";
      setTimeout(() => (alertBox.style.display = "none"), 2000);
    }

    // ü©µ Î°úÍ∑∏Ïù∏
    loginBtn.addEventListener("click", () => {
      const id = loginId.value.trim();
      if (id === "SM0710" || id === "CY0710") {
        currentUser = id === "SM0710" ? "ÍπÄÏÜîÏùå" : "ÏµúÏöîÏõê";
        userDisplay.textContent = `${currentUser} ${currentUser === "ÍπÄÏÜîÏùå" ? "üñ§" : "üíô"}`;
        loginSection.style.display = "none";
        dashboard.style.display = "flex";
        loadAll();
      } else showAlert("ÏïÑÏù¥ÎîîÍ∞Ä Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§!");
    });

    logoutBtn.addEventListener("click", () => {
      currentUser = null;
      dashboard.style.display = "none";
      loginSection.style.display = "flex";
      loginId.value = "";
    });

    // üìù Today Log
    const todayText = document.getElementById("today-text");
    const todaySave = document.getElementById("today-save");
    const todayList = document.getElementById("today-list");

    todaySave.addEventListener("click", async () => {
      const text = todayText.value.trim();
      if (!text || !currentUser) return;
      await addDoc(collection(db, "todayLogs"), {
        text,
        updateBy: currentUser,
        timestamp: serverTimestamp(),
      });
      todayText.value = "";
      showAlert("‚ú® Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!");
    });

    async function loadToday() {
      const q = query(collection(db, "todayLogs"), orderBy("timestamp", "desc"));
      onSnapshot(q, (snap) => {
        todayList.innerHTML = "";
        snap.forEach((docSnap) => {
          const d = docSnap.data();
          const div = document.createElement("div");
          div.className = "p-2 bg-[#e8edf2] rounded-xl shadow-inner flex justify-between items-start fadeIn";
          const date = d.timestamp?.toDate ? new Date(d.timestamp.toDate()) : new Date();
          const dateStr = `${date.getFullYear()}-${date.getMonth()+1}-${date.getDate()} ${date.getHours()}Ïãú${date.getMinutes()}Î∂Ñ`;
          div.innerHTML = `
            <div>
              <strong>${d.updateBy || "ÏùµÎ™Ö"}</strong>
              <p>${d.text}</p>
              <small>${dateStr}</small>
            </div>
            ${d.updateBy === currentUser ? `
              <div class="flex flex-col text-xs ml-2">
                <button class="edit-btn">ÏàòÏ†ï</button>
                <button class="del-btn">ÏÇ≠Ï†ú</button>
              </div>` : ""}
          `;
          if (d.updateBy === currentUser) {
            div.querySelector(".edit-btn").onclick = async () => {
              const newText = prompt("ÏàòÏ†ïÌï† ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:", d.text);
              if (newText) {
                await updateDoc(doc(db, "todayLogs", docSnap.id), { text: newText });
                showAlert("‚ú® ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§!");
              }
            };
            div.querySelector(".del-btn").onclick = async () => {
              await deleteDoc(doc(db, "todayLogs", docSnap.id));
              showAlert("üóëÔ∏è ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§!");
            };
          }
          todayList.appendChild(div);
        });
      });
    }

    // üí¨ Chat
    const chatBox = document.getElementById("chat-box");
    const chatInput = document.getElementById("chat-input");
    const sendBtn = document.getElementById("send-btn");

    sendBtn.addEventListener("click", sendMessage);
    chatInput.addEventListener("keypress", (e) => e.key === "Enter" && sendMessage());

    async function sendMessage() {
      const msg = chatInput.value.trim();
      if (!msg || !currentUser) return;
      await addDoc(collection(db, "chat"), {
        message: msg,
        name: currentUser,
        timestamp: serverTimestamp(),
      });
      chatInput.value = "";
    }

    async function loadChat() {
      const q = query(collection(db, "chat"), orderBy("timestamp", "asc"));
      onSnapshot(q, (snap) => {
        chatBox.innerHTML = "";
        snap.forEach((docSnap) => {
          const d = docSnap.data();
          const date = d.timestamp?.toDate ? new Date(d.timestamp.toDate()) : new Date();
          const dateStr = `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${date.getMinutes()}`;
          const div = document.createElement("div");
          div.className = `chat-message ${d.name === currentUser ? "chat-me self-end" : "chat-other self-start"}`;
          div.innerHTML = `
            <p>${d.message}</p>
            <small>${d.name} ‚Ä¢ ${dateStr}</small>
            ${d.name === currentUser ? `
              <div class="flex justify-end gap-2 text-xs mt-1">
                <button class="edit-btn">ÏàòÏ†ï</button>
                <button class="del-btn">ÏÇ≠Ï†ú</button>
              </div>` : ""}
          `;
          if (d.name === currentUser) {
            div.querySelector(".edit-btn").onclick = async () => {
              const newMsg = prompt("ÏàòÏ†ïÌï† Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî:", d.message);
              if (newMsg) {
                await updateDoc(doc(db, "chat", docSnap.id), { message: newMsg });
                showAlert("‚ú® ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§!");
              }
            };
            div.querySelector(".del-btn").onclick = async () => {
              await deleteDoc(doc(db, "chat", docSnap.id));
              showAlert("üóëÔ∏è ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§!");
            };
          }
          chatBox.appendChild(div);
          chatBox.scrollTop = chatBox.scrollHeight;
        });
      });
    }

    // üì∏ Photo Upload
    const photoUpload = document.getElementById("photo-upload");
    const photoDisplay = document.getElementById("photo-display");

    photoUpload.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const storageRef = ref(storage, `photos/${Date.now()}-${file.name}`);
      await uploadBytes(storageRef, file);
      const url = await getDownloadURL(storageRef);
      await addDoc(collection(db, "photo"), {
        url,
        name: currentUser,
        timestamp: serverTimestamp(),
      });
      showAlert("üì∏ ÏÇ¨ÏßÑÏù¥ ÏóÖÎ°úÎìúÎêòÏóàÏäµÎãàÎã§!");
    });

    async function loadPhoto() {
      const q = query(collection(db, "photo"), orderBy("timestamp", "desc"));
      onSnapshot(q, (snap) => {
        if (!snap.empty) {
          const latest = snap.docs[0].data();
          photoDisplay.src = latest.url;
        }
      });
    }

    // üéµ Playlist
    const musicLink = document.getElementById("music-link");
    const musicAdd = document.getElementById("music-add");
    const musicList = document.getElementById("music-list");

    musicAdd.addEventListener("click", async () => {
      const url = musicLink.value.trim();
      if (!url) return;
      await addDoc(collection(db, "playlist"), {
        url,
        addedBy: currentUser,
        timestamp: serverTimestamp(),
      });
      musicLink.value = "";
      showAlert("üéµ ÌîåÎ†àÏù¥Î¶¨Ïä§Ìä∏Ïóê Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§!");
    });

    async function loadMusic() {
      const q = query(collection(db, "playlist"), orderBy("timestamp", "desc"));
      onSnapshot(q, (snap) => {
        musicList.innerHTML = "";
        snap.forEach((docSnap) => {
          const d = docSnap.data();
          const div = document.createElement("div");
          div.className = "playlist-item";
          div.innerHTML = `
            <iframe width="100%" height="150" src="${d.url.replace("watch?v=", "embed/")}" allowfullscreen></iframe>
            <small class="block mt-1 text-xs text-gray-500">by ${d.addedBy || "ÏùµÎ™Ö"}</small>`;
          musicList.appendChild(div);
        });
      });
    }

    // üì¶ Ï†ÑÏ≤¥ Î°úÎìú
    function loadAll() {
      loadToday();
      loadChat();
      loadPhoto();
      loadMusic();
    }
  </script>
</body>
</html>
