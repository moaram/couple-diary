<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Couple Diary</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBw9CXG7BMyCQ3qMWFaXPfi_gS_HIiXIOA",
      authDomain: "couple-diary-42d49.firebaseapp.com",
      projectId: "couple-diary-42d49",
      storageBucket: "couple-diary-42d49.firebasestorage.app",
      messagingSenderId: "162533479109",
      appId: "1:162533479109:web:a67f8d213bddafc66fd6ac",
      measurementId: "G-2N8R9H692D"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const loginSection = document.getElementById("loginSection");
    const dashboard = document.getElementById("dashboard");
    const userLabel = document.getElementById("userLabel");
    const photoDisplay = document.getElementById("photoDisplay");

    const todayLogList = document.getElementById("todayLogList");
    const todayLogInput = document.getElementById("todayLogInput");

    const chatList = document.getElementById("chatList");
    const chatInput = document.getElementById("chatInput");

    const playlist = document.getElementById("playlist");
    const playlistInput = document.getElementById("playlistInput");

    let currentUser = null;

    // Î°úÍ∑∏Ïù∏
    window.login = () => {
      const id = document.getElementById("userId").value.trim();
      if (!id) return alert("ÏïÑÏù¥ÎîîÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.");
      currentUser = id;
      userLabel.innerHTML = `${id === "SM0710" ? "ÍπÄÏÜîÏùå üñ§" : "ÏµúÏöîÏõê üíô"}`;
      loginSection.classList.add("fade-out");
      setTimeout(() => {
        loginSection.style.display = "none";
        dashboard.style.display = "flex";
        dashboard.classList.add("fade-in");
      }, 500);
      loadAllData();
    };

    // Î°úÍ∑∏ÏïÑÏõÉ
    window.logout = () => {
      currentUser = null;
      dashboard.style.display = "none";
      loginSection.style.display = "flex";
      document.getElementById("userId").value = "";
    };

    // Ïã§ÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
    function loadAllData() {
      // todayLogs
      onSnapshot(query(collection(db, "todayLogs"), orderBy("timestamp", "asc")), (snapshot) => {
        todayLogList.innerHTML = "";
        snapshot.forEach((doc) => {
          const d = doc.data();
          const div = document.createElement("div");
          div.className = "logCard";
          div.innerHTML = `<p>${d.text}</p><span>${d.user} ¬∑ ${formatTime(d.timestamp)}</span>`;
          todayLogList.appendChild(div);
        });
      });

      // chat
      onSnapshot(query(collection(db, "chat"), orderBy("timestamp", "asc")), (snapshot) => {
        chatList.innerHTML = "";
        snapshot.forEach((doc) => {
          const d = doc.data();
          const div = document.createElement("div");
          div.className = `chatCard ${d.user === "SM0710" ? "left" : "right"}`;
          div.innerHTML = `<p>${d.text}</p><span>${formatTime(d.timestamp)}</span>`;
          chatList.appendChild(div);
        });
      });

      // playlist
      onSnapshot(query(collection(db, "playlist"), orderBy("timestamp", "asc")), (snapshot) => {
        playlist.innerHTML = "";
        snapshot.forEach((doc) => {
          const d = doc.data();
          const card = document.createElement("div");
          card.className = "songCard";
          card.innerHTML = `<iframe width="100%" height="100" src="${d.link.replace("watch?v=", "embed/")}" frameborder="0" allowfullscreen></iframe>`;
          playlist.appendChild(card);
        });
      });

      // photo
      onSnapshot(query(collection(db, "photo"), orderBy("timestamp", "desc")), (snapshot) => {
        if (!snapshot.empty) {
          const latest = snapshot.docs[0].data();
          photoDisplay.src = latest.url;
        }
      });
    }

    // Îç∞Ïù¥ÌÑ∞ Ï∂îÍ∞Ä
    window.addTodayLog = async () => {
      if (!todayLogInput.value.trim()) return;
      await addDoc(collection(db, "todayLogs"), {
        text: todayLogInput.value,
        user: currentUser,
        timestamp: serverTimestamp()
      });
      todayLogInput.value = "";
    };

    window.addChat = async () => {
      if (!chatInput.value.trim()) return;
      await addDoc(collection(db, "chat"), {
        text: chatInput.value,
        user: currentUser,
        timestamp: serverTimestamp()
      });
      chatInput.value = "";
    };

    window.addPlaylist = async () => {
      if (!playlistInput.value.trim()) return;
      await addDoc(collection(db, "playlist"), {
        link: playlistInput.value,
        user: currentUser,
        timestamp: serverTimestamp()
      });
      playlistInput.value = "";
    };

    // ÏÇ¨ÏßÑ ÏóÖÎ°úÎìú
    window.uploadPhoto = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async (event) => {
        await addDoc(collection(db, "photo"), {
          url: event.target.result,
          user: currentUser,
          timestamp: serverTimestamp()
        });
      };
      reader.readAsDataURL(file);
    };

    function formatTime(ts) {
      if (!ts) return "";
      const d = ts.toDate();
      return `${d.getFullYear().toString().slice(2)}.${String(d.getMonth() + 1).padStart(2, "0")}.${String(d.getDate()).padStart(2, "0")} ${d.getHours()}Ïãú${String(d.getMinutes()).padStart(2, "0")}Î∂Ñ`;
    }
  </script>

  <style>
    body {
      margin: 0;
      font-family: "Pretendard", sans-serif;
      background: #fff;
      overflow: hidden;
      color: #222;
    }

    /* ÌéòÏù¥Îìú */
    .fade-in { animation: fadeIn 0.8s ease forwards; }
    .fade-out { animation: fadeOut 0.5s ease forwards; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

    /* Î°úÍ∑∏Ïù∏ */
    #loginSection {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    #userId {
      padding: 10px 20px;
      font-size: 1rem;
      border: 2px solid #ffb6a8;
      border-radius: 10px;
      outline: none;
    }
    button {
      margin-top: 10px;
      background: #ffb6a8;
      border: none;
      color: white;
      padding: 10px 20px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
    }

    /* ÎåÄÏãúÎ≥¥Îìú */
    #dashboard {
      display: none;
      height: 100vh;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      gap: 20px;
    }

    #leftPanel, #rightPanel {
      width: 25%;
      height: 80%;
      background: #f7f7f7;
      border-radius: 20px;
      padding: 15px;
      overflow-y: auto;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }

    #centerPanel {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 40%;
      gap: 10px;
    }

    #photoDisplay {
      width: 100%;
      border-radius: 20px;
      object-fit: cover;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    input {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #ddd;
      margin-top: 10px;
    }

    .logCard, .chatCard {
      background: #fff;
      border-radius: 12px;
      padding: 10px;
      margin-bottom: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }

    .chatCard.left { align-self: flex-start; background: #fef0ee; }
    .chatCard.right { align-self: flex-end; background: #e0f0ff; }

    #playlist {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      width: 100%;
      margin-top: 10px;
    }

    .songCard {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      padding: 5px;
    }

    #topBar {
      position: absolute;
      top: 10px;
      right: 20px;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <section id="loginSection">
    <input id="userId" type="text" placeholder="ID ÏûÖÎ†•" />
    <button onclick="login()">Login</button>
  </section>

  <section id="dashboard">
    <div id="topBar">
      <span id="userLabel"></span>
      <button onclick="logout()">Logout</button>
    </div>

    <div id="leftPanel">
      <h3>Ìà¨Îç∞Ïù¥ Î°úÍ∑∏</h3>
      <div id="todayLogList"></div>
      <input id="todayLogInput" placeholder="Ïò§ÎäòÏùò Í∏∞Î°ù ÏûÖÎ†•" onkeypress="if(event.key==='Enter')addTodayLog()" />
    </div>

    <div id="centerPanel">
      <input type="file" accept="image/*" onchange="uploadPhoto(event)" />
      <img id="photoDisplay" src="" alt="couple photo" />
      <div id="playlist"></div>
      <input id="playlistInput" placeholder="YouTube ÎßÅÌÅ¨ ÏûÖÎ†•" onkeypress="if(event.key==='Enter')addPlaylist()" />
    </div>

    <div id="rightPanel">
      <h3>ÎåÄÌôî Î°úÍ∑∏</h3>
      <div id="chatList"></div>
      <input id="chatInput" placeholder="ÎåÄÌôî ÏûÖÎ†•" onkeypress="if(event.key==='Enter')addChat()" />
    </div>
  </section>
</body>
</html>
