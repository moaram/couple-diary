<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Couple Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <style>
    :root {
      --main-bg: #ffffff;
      --accent1: #001f3f; /* ÎÑ§Ïù¥ÎπÑ */
      --accent2: #d11a2a; /* Îπ®Í∞ï */
      --text-dark: #000000;
      --card-bg: #f3f3f3;
    }

    body {
      margin: 0;
      font-family: "Pretendard", sans-serif;
      background: var(--main-bg);
      color: var(--text-dark);
    }

    /* Î°úÍ∑∏Ïù∏ */
    #login-section {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: white;
      z-index: 10;
    }

    #login-section input {
      padding: 10px;
      width: 220px;
      border: 2px solid var(--accent1);
      border-radius: 6px;
      margin-bottom: 10px;
    }

    #login-section button {
      padding: 10px 20px;
      border: none;
      background: var(--accent1);
      color: white;
      border-radius: 6px;
      cursor: pointer;
    }

    /* ÎåÄÏãúÎ≥¥Îìú */
    #dashboard {
      display: none;
      padding: 20px;
    }

    header {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      padding: 10px 20px;
      background: var(--accent1);
      color: white;
      font-size: 16px;
    }

    header span {
      margin-left: 10px;
    }

    .container {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-top: 20px;
      align-items: start;
    }

    .section {
      background: var(--card-bg);
      padding: 15px;
      border-radius: 10px;
    }

    h2 {
      color: var(--accent2);
      font-size: 18px;
      border-bottom: 2px solid var(--accent2);
      padding-bottom: 4px;
    }

    /* ÏÇ¨ÏßÑ */
    .photo-section {
      text-align: center;
    }

    #photo {
      width: 100%;
      max-height: 300px;
      object-fit: cover;
      border-radius: 10px;
      cursor: pointer;
      transition: transform 0.3s;
    }

    #photo:hover {
      transform: scale(1.02);
    }

    /* Î°úÍ∑∏ */
    .log {
      max-height: 300px;
      overflow-y: auto;
      margin-top: 10px;
      font-size: 14px;
    }

    .log-entry {
      background: white;
      padding: 8px;
      border-radius: 6px;
      margin-bottom: 6px;
      line-height: 1.4;
    }

    .log-entry time {
      display: block;
      font-size: 12px;
      color: gray;
      margin-top: 4px;
    }

    /* ÌîåÎ†àÏù¥Î¶¨Ïä§Ìä∏ */
    .playlist {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .card {
      background: white;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      font-size: 12px;
      text-align: center;
    }

    .card iframe {
      width: 100%;
      height: 80px;
      border-radius: 6px;
    }

    @media (max-width: 768px) {
      .container {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Î°úÍ∑∏Ïù∏ -->
  <div id="login-section">
    <input id="login-id" placeholder="IDÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî" />
    <button id="login-btn">Login</button>
  </div>

  <!-- ÎåÄÏãúÎ≥¥Îìú -->
  <div id="dashboard">
    <header>
      <div id="user-info"></div>
    </header>

    <div class="container">
      <!-- ÍπÄÏÜîÏùå -->
      <div class="section" id="solum">
        <h2>ÍπÄÏÜîÏùåÏùò Ìà¨Îç∞Ïù¥ Î°úÍ∑∏</h2>
        <textarea id="today-input" rows="3" placeholder="Ïò§ÎäòÏùÄ Ïñ¥Îï†Ïñ¥?"></textarea>
        <button id="save-today">Ï†ÄÏû•</button>
        <div id="today-log" class="log"></div>
      </div>

      <!-- Ï§ëÏïô ÏÇ¨ÏßÑ -->
      <div class="section photo-section">
        <img id="photo" src="" alt="Ïª§ÌîåÏÇ¨ÏßÑ" title="ÎçîÎ∏îÌÅ¥Î¶≠Ìï¥ÏÑú ÏÇ¨ÏßÑ Î≥ÄÍ≤Ω" />
      </div>

      <!-- ÏµúÏöîÏõê -->
      <div class="section" id="yowon">
        <h2>Ï±ÑÌåÖ Î°úÍ∑∏</h2>
        <textarea id="chat-input" rows="3" placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"></textarea>
        <button id="send-chat">Î≥¥ÎÇ¥Í∏∞</button>
        <div id="chat-log" class="log"></div>
      </div>
    </div>

    <!-- ÌîåÎ†àÏù¥Î¶¨Ïä§Ìä∏ -->
    <div class="section" id="playlist-section" style="margin-top:20px;">
      <h2>Í≥µÏú† ÌîåÎ†àÏù¥Î¶¨Ïä§Ìä∏</h2>
      <input id="playlist-url" placeholder="YouTube ÎßÅÌÅ¨ ÏûÖÎ†•" />
      <button id="add-playlist">Ï∂îÍ∞Ä</button>
      <div id="playlist" class="playlist"></div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBw9CXG7BMyCQ3qMWFaXPfi_gS_HIiXIOA",
      authDomain: "couple-diary-42d49.firebaseapp.com",
      projectId: "couple-diary-42d49",
      storageBucket: "couple-diary-42d49.firebasestorage.app",
      messagingSenderId: "162533479109",
      appId: "1:162533479109:web:a67f8d213bddafc66fd6ac",
      measurementId: "G-2N8R9H692D"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    const loginSection = document.getElementById("login-section");
    const dashboard = document.getElementById("dashboard");
    const userInfo = document.getElementById("user-info");
    const loginBtn = document.getElementById("login-btn");
    const loginId = document.getElementById("login-id");

    const todayInput = document.getElementById("today-input");
    const chatInput = document.getElementById("chat-input");
    const saveTodayBtn = document.getElementById("save-today");
    const sendChatBtn = document.getElementById("send-chat");
    const todayLog = document.getElementById("today-log");
    const chatLog = document.getElementById("chat-log");

    const playlistUrl = document.getElementById("playlist-url");
    const playlistContainer = document.getElementById("playlist");
    const addPlaylistBtn = document.getElementById("add-playlist");

    const photo = document.getElementById("photo");
    let currentUser = null;

    loginBtn.addEventListener("click", async () => {
      const id = loginId.value.trim();
      if (!id) return alert("IDÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî");

      currentUser = id;
      loginSection.style.display = "none";
      dashboard.style.display = "block";

      const heart = id === "SM0710" ? "üñ§" : id === "CY0710" ? "üíô" : "";
      const name = id === "SM0710" ? "ÍπÄÏÜîÏùå" : id === "CY0710" ? "ÏµúÏöîÏõê" : "Guest";
      userInfo.innerHTML = `${name} ${heart}`;

      loadData();
    });

    // --- Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Í∏∞ ---
    async function loadData() {
      const todaySnap = await db.collection("today").orderBy("timestamp").get();
      todayLog.innerHTML = todaySnap.docs.map(doc => {
        const d = doc.data();
        return `<div class="log-entry">${escapeHtml(d.text)}<time>${d.time}</time></div>`;
      }).join("");

      const chatSnap = await db.collection("chat").orderBy("timestamp").get();
      chatLog.innerHTML = chatSnap.docs.map(doc => {
        const d = doc.data();
        return `<div class="log-entry"><b>${d.user}</b>: ${escapeHtml(d.text)}<time>${d.time}</time></div>`;
      }).join("");

      const listSnap = await db.collection("playlist").get();
      playlistContainer.innerHTML = listSnap.docs.map(doc => {
        const d = doc.data();
        return `<div class="card"><iframe src="https://www.youtube.com/embed/${extractYouTubeId(d.url)}?autoplay=1&mute=1"></iframe></div>`;
      }).join("");

      const photoRef = storage.ref("couple-photo.jpg");
      try {
        const url = await photoRef.getDownloadURL();
        photo.src = url;
      } catch (e) {
        photo.src = "https://via.placeholder.com/400x300?text=ÏÇ¨ÏßÑÏùÑ+ÏóÖÎ°úÎìúÌïòÏÑ∏Ïöî";
      }
    }

    // --- Ìà¨Îç∞Ïù¥ Ï†ÄÏû• ---
    saveTodayBtn.addEventListener("click", async () => {
      const text = todayInput.value.trim();
      if (!text) return;
      const time = new Date().toLocaleString("ko-KR", { year: "2-digit", month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit" });
      await db.collection("today").add({ text, user: currentUser, time, timestamp: Date.now() });
      todayInput.value = "";
      loadData();
    });

    // --- Ï±ÑÌåÖ Ï†ÑÏÜ° ---
    sendChatBtn.addEventListener("click", async () => {
      const text = chatInput.value.trim();
      if (!text) return;
      const time = new Date().toLocaleString("ko-KR", { year: "2-digit", month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit" });
      await db.collection("chat").add({ text, user: currentUser, time, timestamp: Date.now() });
      chatInput.value = "";
      loadData();
    });

    // --- ÌîåÎ†àÏù¥Î¶¨Ïä§Ìä∏ Ï∂îÍ∞Ä ---
    addPlaylistBtn.addEventListener("click", async () => {
      const url = playlistUrl.value.trim();
      if (!url) return;
      await db.collection("playlist").add({ url });
      playlistUrl.value = "";
      loadData();
    });

    // --- Ïù¥ÎØ∏ÏßÄ ÎçîÎ∏îÌÅ¥Î¶≠ ÏóÖÎ°úÎìú ---
    photo.addEventListener("dblclick", async () => {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "image/*";
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const ref = storage.ref("couple-photo.jpg");
        await ref.put(file);
        const url = await ref.getDownloadURL();
        photo.src = url;
      };
      input.click();
    });

    function escapeHtml(t){
      const div=document.createElement("div");
      div.innerText=t;
      return div.innerHTML;
    }

    function extractYouTubeId(url){
      const match=url.match(/(?:v=|youtu\.be\/)([^&]+)/);
      return match?match[1]:"";
    }
  </script>
</body>
</html>
