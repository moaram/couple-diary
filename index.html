<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Couple Diary</title>
  <script type="module">
    // --- Firebase SDKs ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp, updateDoc, doc } 
      from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } 
      from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBw9CXG7BMyCQ3qMWFaXPfi_gS_HIiXIOA",
      authDomain: "couple-diary-42d49.firebaseapp.com",
      projectId: "couple-diary-42d49",
      storageBucket: "couple-diary-42d49.firebasestorage.app",
      messagingSenderId: "162533479109",
      appId: "1:162533479109:web:a67f8d213bddafc66fd6ac",
      measurementId: "G-2N8R9H692D"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // --- Login ---
    window.login = async function() {
      const id = document.getElementById("userId").value.trim();
      let name = "";
      let heart = "";

      if (id === "SM0710") {
        name = "김솔음 🖤";
        heart = "black";
      } else if (id === "CY0710") {
        name = "최요원 💙";
        heart = "navy";
      } else {
        alert("등록되지 않은 ID입니다.");
        return;
      }

      localStorage.setItem("userId", id);
      localStorage.setItem("userName", name);
      localStorage.setItem("heartColor", heart);

      document.getElementById("loginSection").style.display = "none";
      document.getElementById("dashboard").style.display = "flex";
      document.getElementById("userDisplay").innerText = name;
      loadAll();
    };

    window.logout = function() {
      localStorage.clear();
      location.reload();
    };

    // --- Load All Data ---
    async function loadAll() {
      await loadTodayLogs();
      await loadChat();
      await loadPhotos();
      await loadPlaylist();
    }

    // --- Today Logs ---
    async function loadTodayLogs() {
      const q = query(collection(db, "todayLogs"), orderBy("timestamp", "desc"));
      const snapshot = await getDocs(q);
      const container = document.getElementById("todayContainer");
      container.innerHTML = "";
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const div = document.createElement("div");
        div.className = "logCard";
        const isMe = data.updateBy === localStorage.getItem("userName");
        div.innerHTML = `
          <p>${data.text}</p>
          <small>${data.updateBy} | ${formatDate(data.timestamp?.toDate())}</small>
          ${isMe ? `<button onclick="editToday('${docSnap.id}','${data.text}')">수정</button>` : ""}
        `;
        container.appendChild(div);
      });
    }

    window.addToday = async function() {
      const text = document.getElementById("todayInput").value.trim();
      if (!text) return;
      await addDoc(collection(db, "todayLogs"), {
        text,
        updateBy: localStorage.getItem("userName"),
        timestamp: serverTimestamp(),
      });
      document.getElementById("todayInput").value = "";
      loadTodayLogs();
    };

    window.editToday = async function(id, oldText) {
      const newText = prompt("수정할 내용을 입력하세요:", oldText);
      if (!newText) return;
      await updateDoc(doc(db, "todayLogs", id), {
        text: newText,
        timestamp: serverTimestamp(),
      });
      loadTodayLogs();
    };

    // --- Chat Logs ---
    async function loadChat() {
      const q = query(collection(db, "chat"), orderBy("timestamp", "asc"));
      const snapshot = await getDocs(q);
      const container = document.getElementById("chatContainer");
      container.innerHTML = "";
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const isMe = data.name === localStorage.getItem("userName");
        const chatDiv = document.createElement("div");
        chatDiv.className = `chatMessage ${isMe ? "right" : "left"}`;
        chatDiv.innerHTML = `
          <div class="bubble">${data.message}</div>
          <small>${data.name} | ${formatDate(data.timestamp?.toDate())}</small>
          ${isMe ? `<button onclick="editChat('${docSnap.id}','${data.message}')">수정</button>` : ""}
        `;
        container.appendChild(chatDiv);
      });
    }

    window.addChat = async function() {
      const msg = document.getElementById("chatInput").value.trim();
      if (!msg) return;
      await addDoc(collection(db, "chat"), {
        message: msg,
        name: localStorage.getItem("userName"),
        timestamp: serverTimestamp(),
      });
      document.getElementById("chatInput").value = "";
      loadChat();
    };

    window.editChat = async function(id, oldMsg) {
      const newMsg = prompt("수정할 메시지를 입력하세요:", oldMsg);
      if (!newMsg) return;
      await updateDoc(doc(db, "chat", id), { message: newMsg, timestamp: serverTimestamp() });
      loadChat();
    };

    // --- Photos ---
    async function loadPhotos() {
      const q = query(collection(db, "photo"), orderBy("timestamp", "desc"));
      const snapshot = await getDocs(q);
      const container = document.getElementById("photoContainer");
      container.innerHTML = "";
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const img = document.createElement("img");
        img.src = data.url;
        img.className = "photoItem";
        container.appendChild(img);
      });
    }

    window.uploadPhoto = async function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const fileRef = ref(storage, `photos/${Date.now()}_${file.name}`);
      await uploadBytes(fileRef, file);
      const url = await getDownloadURL(fileRef);
      await addDoc(collection(db, "photo"), {
        name: localStorage.getItem("userName"),
        url,
        timestamp: serverTimestamp(),
      });
      loadPhotos();
    };

    // --- Playlist ---
    async function loadPlaylist() {
      const q = query(collection(db, "playlist"), orderBy("timestamp", "desc"));
      const snapshot = await getDocs(q);
      const container = document.getElementById("playlistContainer");
      container.innerHTML = "";
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const card = document.createElement("div");
        card.className = "songCard";
        card.innerHTML = `
          <iframe src="${data.url}" allow="autoplay; encrypted-media" loading="lazy"></iframe>
          <small>${data.addedBy} | ${formatDate(data.timestamp?.toDate())}</small>
        `;
        container.appendChild(card);
      });
    }

    window.addPlaylist = async function() {
      const url = document.getElementById("playlistInput").value.trim();
      if (!url) return;
      await addDoc(collection(db, "playlist"), {
        url,
        addedBy: localStorage.getItem("userName"),
        timestamp: serverTimestamp(),
      });
      document.getElementById("playlistInput").value = "";
      loadPlaylist();
    };

    function formatDate(date) {
      if (!date) return "";
      return `${date.getFullYear()}.${String(date.getMonth() + 1).padStart(2, "0")}.${String(date.getDate()).padStart(2, "0")} ${date.getHours()}시 ${date.getMinutes()}분`;
    }

    window.onload = function() {
      const uid = localStorage.getItem("userId");
      if (uid) {
        document.getElementById("loginSection").style.display = "none";
        document.getElementById("dashboard").style.display = "flex";
        document.getElementById("userDisplay").innerText = localStorage.getItem("userName");
        loadAll();
      }
    };
  </script>

  <style>
    body {
      margin: 0;
      font-family: "Pretendard", sans-serif;
      background: #fffaf8;
      color: #333;
      overflow-x: hidden;
    }

    #loginSection {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    .loginBox {
      background: white;
      padding: 50px;
      border-radius: 25px;
      box-shadow: 0 0 25px rgba(255, 170, 150, 0.4);
      text-align: center;
    }

    #dashboard {
      display: none;
      justify-content: space-between;
      align-items: flex-start;
      padding: 30px;
      gap: 20px;
    }

    #todayContainer, #chatContainer {
      flex: 1;
      min-height: 400px;
      max-height: 75vh;
      overflow-y: auto;
      background: #fff5f2;
      border-radius: 20px;
      padding: 15px;
    }

    #photoContainer {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
      background: #fff5f2;
      border-radius: 20px;
      padding: 15px;
    }

    img.photoItem {
      width: 100%;
      border-radius: 15px;
      object-fit: cover;
    }

    #playlistContainer {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 15px;
      margin-top: 30px;
    }

    .songCard iframe {
      width: 100%;
      height: 100px;
      border-radius: 12px;
    }

    #topBar {
      position: fixed;
      top: 0;
      right: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      background: white;
      padding: 10px 15px;
      border-radius: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    button {
      cursor: pointer;
      background: #ff8e80;
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 12px;
      font-weight: 600;
      transition: background 0.2s ease;
    }

    button:hover {
      background: #ff7061;
    }
  </style>
</head>

<body>
  <section id="loginSection">
    <div class="loginBox">
      <h1>Couple Diary</h1>
      <input id="userId" type="text" placeholder="Enter your ID" />
      <button onclick="login()">Login</button>
    </div>
  </section>

  <div id="topBar">
    <span id="userDisplay"></span>
    <button onclick="logout()">Logout</button>
  </div>

  <section id="dashboard">
    <!-- Left: Today Logs -->
    <div style="flex:1;">
      <h2>투데이 로그</h2>
      <div id="todayContainer"></div>
      <input id="todayInput" placeholder="오늘의 기록" onkeypress="if(event.key==='Enter')addToday()" />
      <button onclick="addToday()">입력</button>
    </div>

    <!-- Center: Photo -->
    <div id="photoContainer">
      <h2>사진</h2>
      <input type="file" accept="image/*" onchange="uploadPhoto(event)" />
    </div>

    <!-- Right: Chat -->
    <div style="flex:1;">
      <h2>채팅</h2>
      <div id="chatContainer"></div>
      <input id="chatInput" placeholder="대화 입력" onkeypress="if(event.key==='Enter')addChat()" />
      <button onclick="addChat()">입력</button>
    </div>
  </section>

  <section style="padding:30px;">
    <h2>플레이리스트</h2>
    <div id="playlistContainer"></div>
    <input id="playlistInput" placeholder="YouTube 링크 입력" onkeypress="if(event.key==='Enter')addPlaylist()" />
    <button onclick="addPlaylist()">추가</button>
  </section>
</body>
</html>
