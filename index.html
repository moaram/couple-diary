<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Couple Diary ‚Äî Final</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Soft gray + blue theme, balanced 3-column layout */
    :root{
      --bg1:#f3f6fa;
      --panel:#ffffff;
      --accent:#5d7ea6;
      --muted:#7f8a97;
      --soft:#e9eef5;
    }
    html,body{height:100%;margin:0;font-family:Inter, 'Noto Sans KR', sans-serif;background:var(--bg1);color:#24343f;}
    .wrap{max-width:1200px;margin:24px auto;padding:16px;}
    .topbar{display:flex;justify-content:flex-end;align-items:center;gap:12px;margin-bottom:14px}
    .badge{font-weight:700;color:var(--accent);}

    .grid{display:grid;grid-template-columns:1fr 1.1fr 1fr;gap:16px;}
    @media(max-width:960px){ .grid{grid-template-columns:1fr; } }

    .panel{
      background:var(--panel);
      border-radius:14px;
      padding:14px;
      box-shadow:6px 6px 16px rgba(0,0,0,0.04), -6px -6px 16px rgba(255,255,255,0.9);
      min-height:420px;
      display:flex;flex-direction:column;
    }

    input, textarea, select {
      border: none; outline: none;
      background: var(--soft); padding:10px;border-radius:10px;
      box-shadow: inset 3px 3px 8px rgba(0,0,0,0.03), inset -3px -3px 8px #fff;
      font-size:14px;
    }
    textarea{min-height:100px; resize:vertical;}

    .btn {
      background: linear-gradient(135deg,#6b8bb3,#4e6f9a);
      color: white; border:none; padding:8px 14px; border-radius:999px; cursor:pointer; font-weight:700;
      box-shadow: 2px 6px 14px rgba(77,108,153,0.12);
      white-space: nowrap;
    }
    .btn.ghost { background: transparent; color:var(--muted); box-shadow:none; border:1px solid rgba(0,0,0,0.04); }

    .list { overflow:auto; padding-right:6px; display:flex; flex-direction:column; gap:10px; flex:1; }
    .card {
      background:#fbfdff; border-radius:10px; padding:10px; box-shadow: 2px 4px 10px rgba(0,0,0,0.03);
    }
    .meta{ font-size:12px; color:var(--muted); margin-top:6px;}
    .author{ font-size:13px; color:#34506a; margin-top:6px; }

    /* Chat */
    .chat-area{ display:flex; flex-direction:column; gap:10px; flex:1; overflow:hidden; }
    .chat-list{ overflow:auto; display:flex; flex-direction:column; gap:8px; padding-bottom:6px; flex:1; }
    .bubble{ max-width:78%; padding:8px 10px; border-radius:14px; font-size:14px; box-shadow:2px 4px 10px rgba(0,0,0,0.03); }
    .bubble.me{ margin-left:auto; background:#dfeffb; }
    .bubble.you{ margin-right:auto; background:#f3f7fb; }

    /* Photo */
    .photo-wrap{ display:flex; flex-direction:column; gap:10px; align-items:stretch; }
    .photo-wrap img{ width:100%; height:auto; max-height:480px; object-fit:cover; border-radius:10px; background:#f6f8fb; }

    /* Playlist grid */
    .music-grid{ display:grid; grid-template-columns:repeat(1,1fr); gap:12px; margin-top:12px; }
    @media(min-width:640px){ .music-grid{ grid-template-columns:repeat(2,1fr);} }
    @media(min-width:1000px){ .music-grid{ grid-template-columns:repeat(3,1fr);} }
    .music-card{ background:#fff; border-radius:12px; overflow:hidden; box-shadow:2px 6px 18px rgba(20,40,60,0.04); display:flex; flex-direction:column; }
    .thumb{ width:100%; height:150px; object-fit:cover; background:#eee; display:block; }
    .music-info{ padding:10px; display:flex; flex-direction:column; gap:6px; }

    /* tiny action */
    .actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:8px; }
    .action-btn{ background:transparent;border:none;color:var(--muted);cursor:pointer;font-size:13px; }

    /* login */
    #login-screen{ min-height:100vh; display:flex; align-items:center; justify-content:center; background:linear-gradient(180deg,#f7fafc,#eef4fb); }
    .login-card{ width:100%; max-width:420px; padding:28px; border-radius:14px; background:var(--panel); box-shadow:10px 20px 40px rgba(32,64,96,0.06); text-align:center; }

    /* small helpers */
    a { color:inherit; text-decoration:none; }
  </style>
</head>
<body>
  <!-- LOGIN (simple ID-based) -->
  <div id="login-screen">
    <div class="login-card">
      <h2 style="margin:0 0 12px 0; color:var(--accent)">Couple Diary</h2>
      <input id="login-id" placeholder="ID ÏûÖÎ†• (SM0710 / CY0710)" style="margin-bottom:12px; text-align:center;" />
      <div style="display:flex;gap:8px;justify-content:center">
        <button id="login-btn" class="btn">Login</button>
      </div>
      <div style="margin-top:10px;font-size:13px;color:var(--muted)">SM0710 = ÍπÄÏÜîÏùå ¬∑ CY0710 = ÏµúÏöîÏõê</div>
    </div>
  </div>

  <!-- MAIN -->
  <div class="wrap" id="app" style="display:none;">
    <div class="topbar">
      <div id="user-display" class="badge"></div>
      <button id="logout-btn" class="btn ghost">Logout</button>
    </div>

    <div class="grid">
      <!-- LEFT: Today -->
      <section class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h3 style="margin:0">üìî Today Log</h3>
        </div>

        <textarea id="today-input" placeholder="Ïò§ÎäòÏùò Í∏∞Î°ùÏùÑ ÎÇ®Í≤®Î≥¥ÏÑ∏Ïöî..." style="margin-top:10px"></textarea>
        <div style="display:flex;gap:8px;margin-top:10px">
          <button id="today-save" class="btn" style="flex:1">Ï†ÄÏû•</button>
        </div>

        <div class="list" id="today-list" style="margin-top:12px"></div>
      </section>

      <!-- CENTER: Photo -->
      <section class="panel">
        <h3 style="margin:0">üì∏ Couple Photo</h3>
        <div class="photo-wrap" style="margin-top:10px">
          <img id="photo-display" src="" alt="couple photo" />
          <input id="photo-upload" type="file" accept="image/*" />
          <div class="meta">ÏóÖÎ°úÎìúÌïòÎ©¥ Ï†ÄÏû•ÎêòÏñ¥ Î™®ÎëêÍ∞Ä Î≥º Ïàò ÏûàÏñ¥Ïöî.</div>
        </div>

        <!-- playlist below center -->
        <div style="margin-top:18px">
          <h3 style="margin:0">üéµ Playlist</h3>
          <div style="display:flex;gap:8px;margin-top:10px">
            <input id="music-link" placeholder="YouTube ÎßÅÌÅ¨ ÏûÖÎ†•" />
            <button id="music-add" class="btn">Ï∂îÍ∞Ä</button>
          </div>
          <div class="music-grid" id="music-list"></div>
        </div>
      </section>

      <!-- RIGHT: Chat -->
      <section class="panel" style="display:flex;flex-direction:column;">
        <h3 style="margin:0 0 8px 0">üí¨ Chat</h3>

        <div class="chat-area" style="flex:1;min-height:280px;">
          <div class="chat-list" id="chat-list" style="flex:1;overflow:auto;padding-bottom:6px"></div>

          <div style="display:flex;gap:8px;margin-top:10px">
            <input id="chat-input" placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî" />
            <button id="chat-send" class="btn">Î≥¥ÎÇ¥Í∏∞</button>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- FIREBASE + APP LOGIC -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore, collection, query, orderBy, onSnapshot,
      addDoc, updateDoc, deleteDoc, doc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

    // firebase config (you provided earlier)
    const firebaseConfig = {
      apiKey: "AIzaSyBw9CXG7BMyCQ3qMWFaXPfi_gS_HIiXIOA",
      authDomain: "couple-diary-42d49.firebaseapp.com",
      projectId: "couple-diary-42d49",
      storageBucket: "couple-diary-42d49.firebasestorage.app",
      messagingSenderId: "162533479109",
      appId: "1:162533479109:web:a67f8d213bddafc66fd6ac",
      measurementId: "G-2N8R9H692D"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // DOM
    const loginScreen = document.getElementById('login-screen');
    const loginId = document.getElementById('login-id');
    const loginBtn = document.getElementById('login-btn');

    const appWrap = document.getElementById('app');
    const userDisplay = document.getElementById('user-display');
    const logoutBtn = document.getElementById('logout-btn');

    const todayInput = document.getElementById('today-input');
    const todaySave = document.getElementById('today-save');
    const todayList = document.getElementById('today-list');

    const photoUpload = document.getElementById('photo-upload');
    const photoDisplay = document.getElementById('photo-display');

    const musicLink = document.getElementById('music-link');
    const musicAdd = document.getElementById('music-add');
    const musicList = document.getElementById('music-list');

    const chatInput = document.getElementById('chat-input');
    const chatSend = document.getElementById('chat-send');
    const chatList = document.getElementById('chat-list');

    let currentUser = null;

    function formatTs(ts){
      if(!ts) return "";
      try {
        // Firestore Timestamp object has toDate()
        if (typeof ts.toDate === "function") {
          const d = ts.toDate();
          return `${d.getFullYear()}.${String(d.getMonth()+1).padStart(2,'0')}.${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
        } else {
          const d = new Date(ts);
          return `${d.getFullYear()}.${String(d.getMonth()+1).padStart(2,'0')}.${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
        }
      } catch(e){ return ""; }
    }

    // LOGIN (simple ID)
    loginBtn.addEventListener('click', () => {
      const id = loginId.value.trim();
      if(id === "SM0710") currentUser = { name: "ÍπÄÏÜîÏùå", heart: "üñ§" };
      else if(id === "CY0710") currentUser = { name: "ÏµúÏöîÏõê", heart: "üíô" };
      else { alert("Îì±Î°ùÎêòÏßÄ ÏïäÏùÄ IDÏûÖÎãàÎã§."); return; }

      loginScreen.style.display = 'none';
      appWrap.style.display = 'block';
      userDisplay.textContent = `${currentUser.heart} ${currentUser.name}`;

      subscribeAll();
    });

    logoutBtn.addEventListener('click', () => {
      // simple reload to clear state
      location.reload();
    });

    // SUBSCRIPTIONS
    let unsubToday=null, unsubChat=null, unsubPhoto=null, unsubMusic=null;

    function subscribeAll(){
      // todayLogs (desc: newest first)
      const qToday = query(collection(db, "todayLogs"), orderBy("timestamp", "desc"));
      unsubToday = onSnapshot(qToday, snap => {
        todayList.innerHTML = "";
        snap.forEach(docSnap => {
          const d = docSnap.data();
          const id = docSnap.id;
          const author = d.updatedBy || d.updateBy || "ÏùµÎ™Ö";
          const dateText = d.date || formatTs(d.timestamp);
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:start;gap:12px">
              <div>
                <div style="font-weight:700">${escapeHtml(d.text)}</div>
                <div class="meta">${escapeHtml(dateText)}</div>
                <div class="author">by ${escapeHtml(author)}</div>
              </div>
              <div>
                ${author === currentUser.name ? `<div class="actions">
                  <button class="action-btn edit-today" data-id="${id}">‚úèÔ∏è</button>
                  <button class="action-btn del-today" data-id="${id}">üóëÔ∏è</button>
                </div>` : ''}
              </div>
            </div>
          `;
          todayList.appendChild(card);
        });

        // attach local event handlers
        todayList.querySelectorAll('.del-today').forEach(btn=>{
          btn.onclick = async (e) => {
            const id = e.currentTarget.dataset.id;
            if(confirm("Ï†ïÎßê ÏÇ≠Ï†úÌï†ÍπåÏöî?")) await deleteDoc(doc(db,"todayLogs", id));
          };
        });
        todayList.querySelectorAll('.edit-today').forEach(btn=>{
          btn.onclick = async (e) => {
            const id = e.currentTarget.dataset.id;
            const ref = doc(db,"todayLogs", id);
            const snap = await ref.get?.() || null; // safety - some envs
            // fetch current text via snapshot from Firestore directly by reading doc
            const current = (await (await import("https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js")).getDoc(ref)).data()?.text || "";
            const nxt = prompt("ÏàòÏ†ïÌï† ÎÇ¥Ïö©:", current);
            if(nxt!==null) await updateDoc(ref, { text: nxt, updatedBy: currentUser.name, timestamp: serverTimestamp() });
          };
        });
      });

      // chat (asc so newest at bottom)
      const qChat = query(collection(db, "chat"), orderBy("timestamp", "asc"));
      unsubChat = onSnapshot(qChat, snap => {
        chatList.innerHTML = "";
        snap.forEach(docSnap => {
          const d = docSnap.data();
          const who = d.name || "ÏùµÎ™Ö";
          const bubble = document.createElement('div');
          bubble.className = 'bubble ' + (who === currentUser.name ? 'me' : 'you');
          bubble.innerHTML = `<div style="font-size:14px">${escapeHtml(d.message)}</div><div class="meta">${escapeHtml(who)} ¬∑ ${formatTs(d.timestamp)}</div>`;
          const wrapper = document.createElement('div');
          wrapper.style.display = 'flex';
          wrapper.style.justifyContent = (who === currentUser.name ? 'flex-end' : 'flex-start');
          wrapper.appendChild(bubble);

          // add edit/delete if author
          if(d.name === currentUser.name){
            const act = document.createElement('div');
            act.style.marginLeft = '8px';
            act.innerHTML = `<button class="action-btn edit-chat" data-id="${docSnap.id}">‚úèÔ∏è</button><button class="action-btn del-chat" data-id="${docSnap.id}">üóëÔ∏è</button>`;
            wrapper.appendChild(act);
          }
          chatList.appendChild(wrapper);
        });

        // attach chat edit/delete
        chatList.querySelectorAll('.del-chat').forEach(b=>{
          b.onclick = async e => {
            const id = e.currentTarget.dataset.id;
            if(confirm("Ï†ïÎßê ÏÇ≠Ï†úÌï†ÍπåÏöî?")) await deleteDoc(doc(db,"chat", id));
          };
        });
        chatList.querySelectorAll('.edit-chat').forEach(b=>{
          b.onclick = async e => {
            const id = e.currentTarget.dataset.id;
            const ref = doc(db,"chat", id);
            const cur = (await (await import("https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js")).getDoc(ref)).data()?.message || "";
            const nx = prompt("Î©îÏãúÏßÄ ÏàòÏ†ï:", cur);
            if(nx !== null) await updateDoc(ref, { message: nx, timestamp: serverTimestamp() });
          };
        });

        chatList.scrollTop = chatList.scrollHeight;
      });

      // photo - show latest
      const qPhoto = query(collection(db, "photo"), orderBy("timestamp", "desc"));
      unsubPhoto = onSnapshot(qPhoto, snap => {
        if(snap.empty){ photoDisplay.src = ""; return; }
        // show first (latest)
        const first = snap.docs[0].data();
        if(first && first.url) photoDisplay.src = first.url;
      });

      // playlist
      const qPlay = query(collection(db, "playlist"), orderBy("timestamp", "desc"));
      unsubMusic = onSnapshot(qPlay, snap => {
        musicList.innerHTML = "";
        snap.forEach(async docSnap => {
          const d = docSnap.data();
          const id = docSnap.id;
          const url = d.url || "";
          // try extract youtube id
          const vidMatch = url.match(/(?:v=|youtu\.be\/|\/embed\/)([A-Za-z0-9_-]{6,})/);
          const vid = vidMatch ? vidMatch[1] : null;
          const thumb = vid ? `https://img.youtube.com/vi/${vid}/hqdefault.jpg` : '';
          // get title via noembed
          let title = d.title || '';
          if(!title && vid){
            try {
              const res = await fetch(`https://noembed.com/embed?url=https://www.youtube.com/watch?v=${vid}`);
              const j = await res.json();
              title = j.title || url;
            } catch(e){ title = url; }
          } else if(!title) title = url;

          const card = document.createElement('div');
          card.className = 'music-card';
          card.innerHTML = `
            <img class="thumb" src="${thumb}" alt="thumb" onerror="this.style.display='none'"/>
            <div class="music-info">
              <a href="${escapeHtml(url)}" target="_blank" rel="noreferrer">${escapeHtml(title)}</a>
              <div class="meta">${escapeHtml(d.addedBy || '')} ¬∑ ${formatTs(d.timestamp)}</div>
              ${d.addedBy === currentUser.name ? `<div class="actions">
                <button class="action-btn edit-music" data-id="${id}">‚úèÔ∏è</button>
                <button class="action-btn del-music" data-id="${id}">üóëÔ∏è</button>
              </div>` : ''}
            </div>
          `;
          musicList.appendChild(card);
        });

        // attach events
        musicList.querySelectorAll('.del-music').forEach(b=>{
          b.onclick = async e => {
            const id = e.currentTarget.dataset.id;
            if(confirm("Ï†ïÎßê ÏÇ≠Ï†úÌï†ÍπåÏöî?")) await deleteDoc(doc(db, "playlist", id));
          };
        });
        musicList.querySelectorAll('.edit-music').forEach(b=>{
          b.onclick = async e => {
            const id = e.currentTarget.dataset.id;
            const ref = doc(db, "playlist", id);
            const prev = (await (await import("https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js")).getDoc(ref)).data()?.url || "";
            const nx = prompt("ÏÉà ÎßÅÌÅ¨ ÏûÖÎ†•:", prev);
            if(nx !== null) await updateDoc(ref, { url: nx, addedBy: currentUser.name, timestamp: serverTimestamp() });
          };
        });
      });
    }

    // CREATE operations
    document.getElementById('today-save').addEventListener('click', async ()=>{
      const txt = todayInput.value.trim();
      if(!txt) { alert("ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"); return; }
      await addDoc(collection(db,"todayLogs"), {
        date: new Date().toISOString().slice(0,10).replace(/-/g,'.'),
        text: txt,
        timestamp: serverTimestamp(),
        updatedBy: currentUser.name
      });
      todayInput.value='';
    });

    document.getElementById('chat-send').addEventListener('click', async ()=>{
      const txt = chatInput.value.trim();
      if(!txt) return;
      await addDoc(collection(db,"chat"), {
        message: txt,
        name: currentUser.name,
        heart: currentUser.heart,
        timestamp: serverTimestamp()
      });
      chatInput.value='';
    });
    chatInput.addEventListener('keypress', e => { if(e.key === 'Enter') document.getElementById('chat-send').click(); });

    document.getElementById('music-add').addEventListener('click', async ()=>{
      const url = musicLink.value.trim();
      if(!url) { alert("ÎßÅÌÅ¨Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"); return; }
      await addDoc(collection(db,"playlist"), {
        url, addedBy: currentUser.name, timestamp: serverTimestamp()
      });
      musicLink.value='';
    });

    // photo upload -> storage + firestore
    photoUpload.addEventListener('change', async (e)=>{
      const file = e.target.files?.[0];
      if(!file) return;
      const path = `photos/${Date.now()}_${file.name}`;
      const storageRef = ref(storage, path);
      await uploadBytes(storageRef, file);
      const url = await getDownloadURL(storageRef);
      await addDoc(collection(db,"photo"), { url, name: currentUser.name, timestamp: serverTimestamp() });
    });

    // escape helper
    function escapeHtml(s){ if(!s) return ""; return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
  </script>
</body>
</html>
