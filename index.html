<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Couple Diary Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    // ===== Firebase ì„¤ì • =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore, doc, setDoc, getDoc, onSnapshot, collection, addDoc, deleteDoc, serverTimestamp, query, orderBy
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBw9CXG7BMyCQ3qMWFaXPfi_gS_HIiXIOA",
      authDomain: "couple-diary-42d49.firebaseapp.com",
      projectId: "couple-diary-42d49",
      storageBucket: "couple-diary-42d49.firebasestorage.app",
      messagingSenderId: "162533479109",
      appId: "1:162533479109:web:a67f8d213bddafc66fd6ac",
      measurementId: "G-2N8R9H692D"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ===== ë¡œê·¸ì¸ ê¸°ëŠ¥ =====
    let currentUser = null;
    const loginSection = document.getElementById("login-section");
    const dashboard = document.getElementById("dashboard");
    const loginBtn = document.getElementById("login-btn");
    const logoutBtn = document.getElementById("logout-btn");
    const userDisplay = document.getElementById("user-display");
    const loginInput = document.getElementById("login-id");

    loginBtn.addEventListener("click", async () => {
      const id = loginInput.value.trim();
      if (!id) return alert("IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” ğŸ’¬");

      if (id === "SM0710") currentUser = { name: "ê¹€ì†”ìŒ", heart: "ğŸ–¤" };
      else if (id === "CY0710") currentUser = { name: "ìµœìš”ì›", heart: "ğŸ’™" };
      else return alert("ë“±ë¡ë˜ì§€ ì•Šì€ IDì…ë‹ˆë‹¤ âŒ");

      loginSection.classList.add("hidden");
      dashboard.classList.remove("hidden");
      userDisplay.textContent = `${currentUser.heart} ${currentUser.name}`;
      loadChat();
      loadToday();
    });

    logoutBtn.addEventListener("click", () => {
      currentUser = null;
      dashboard.classList.add("hidden");
      loginSection.classList.remove("hidden");
      loginInput.value = "";
    });

    // ===== Todayâ€™s Page ì €ì¥/ë¡œë“œ =====
    const todayInput = document.getElementById("today-input");
    const todayText = document.getElementById("today-text");
    const todaySaveBtn = document.getElementById("today-save");

    async function loadToday() {
      const docRef = doc(db, "today", "entry");
      const snapshot = await getDoc(docRef);
      if (snapshot.exists()) todayText.value = snapshot.data().text || "";
    }

    todaySaveBtn.addEventListener("click", async () => {
      if (!currentUser) return;
      await setDoc(doc(db, "today", "entry"), {
        text: todayText.value,
        updatedBy: currentUser.name,
        timestamp: serverTimestamp(),
      });
      alert("ì˜¤ëŠ˜ì˜ ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤ âœ¨");
    });

    // ===== Our Chat Log =====
    const chatBox = document.getElementById("chat-box");
    const chatInput = document.getElementById("chat-message");

    async function loadChat() {
      const q = query(collection(db, "chat"), orderBy("timestamp", "desc"));
      onSnapshot(q, (snapshot) => {
        chatBox.innerHTML = "";
        snapshot.forEach((docSnap) => {
          const chat = docSnap.data();
          const wrapper = document.createElement("div");
          wrapper.className = "bg-white px-3 py-1 rounded-lg shadow-sm mb-2 flex justify-between items-center";
          wrapper.innerHTML = `
            <span><strong>${chat.heart} ${chat.name}</strong> <span class="ml-1 text-gray-700">${chat.message}</span></span>
            ${currentUser && currentUser.name === "ìµœìš”ì›"
              ? `<button class="text-red-500 text-xs delete-btn" data-id="${docSnap.id}">ì‚­ì œ</button>`
              : ""}
          `;
          chatBox.appendChild(wrapper);
        });

        document.querySelectorAll(".delete-btn").forEach((btn) => {
          btn.addEventListener("click", async () => {
            await deleteDoc(doc(db, "chat", btn.dataset.id));
          });
        });
      });
    }

    async function sendChat() {
      const msg = chatInput.value.trim();
      if (!msg || !currentUser) return;
      await addDoc(collection(db, "chat"), {
        name: currentUser.name,
        heart: currentUser.heart,
        message: msg,
        timestamp: serverTimestamp(),
      });
      chatInput.value = "";
    }

    document.getElementById("send-btn").addEventListener("click", sendChat);
    chatInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") sendChat();
    });

    // ===== Anniversary ìë™ ê³„ì‚° =====
    const startDate = new Date("2025-07-10");
    const today = new Date();
    const diffDays = Math.floor((today - startDate) / (1000 * 60 * 60 * 24)) + 1;

    document.getElementById("day-count").textContent = `${diffDays}ì¼ì§¸`;

    function formatDate(date) {
      return `${String(date.getFullYear()).slice(2)}.${String(date.getMonth() + 1).padStart(2, "0")}.${String(date.getDate()).padStart(2, "0")}`;
    }

    const ddayList = [
      { name: "ğŸ’¯ 100ì¼", days: 100 },
      { name: "ğŸ’ 200ì¼", days: 200 },
      { name: "ğŸ’– 1ì£¼ë…„", days: 365 },
    ];

    const annivBody = document.getElementById("anniversary-table");
    ddayList.forEach((item) => {
      const ddayDate = new Date(startDate.getTime() + (item.days - 1) * 24 * 60 * 60 * 1000);
      const remain = Math.ceil((ddayDate - today) / (1000 * 60 * 60 * 24));
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="py-2">${item.name}</td>
        <td>${formatDate(ddayDate)}</td>
        <td>${remain > 0 ? `${remain}ì¼ ë‚¨ìŒ` : `${Math.abs(remain)}ì¼ ì§€ë‚¨`}</td>
      `;
      annivBody.appendChild(tr);
    });
  </script>

  <style>
    body {
      font-family: 'Noto Serif KR', serif;
      background-image: url('https://images.unsplash.com/photo-1517841905240-472988babdf9?auto=format&fit=crop&w=1600&q=80');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }
  </style>
</head>
<body class="bg-white/80 text-black flex flex-col items-center px-5 py-10 min-h-screen">

  <!-- ë¡œê·¸ì¸ -->
  <section id="login-section" class="text-center space-y-4">
    <h1 class="text-3xl font-bold">ğŸ’•Login</h1>
    <input id="login-id" type="text" placeholder="ID ì…ë ¥ (SM0710)"
      class="border px-3 py-2 rounded w-64 focus:outline-none focus:ring-1 focus:ring-gray-400" />
    <button id="login-btn" class="bg-black text-white px-4 py-2 rounded hover:bg-gray-800 w-64">ë¡œê·¸ì¸</button>
  </section>

  <!-- ëŒ€ì‹œë³´ë“œ -->
  <main id="dashboard" class="hidden w-full max-w-3xl space-y-10">
    <header class="text-center mb-10">
      <h1 class="text-4xl font-bold mb-2">ğŸ–¤</h1>
      <p class="text-gray-600">í¬ë„ì•¼ ì‚¬ë‘í•´í•´</p>
      <p id="user-display" class="mt-2 font-semibold"></p>
      <button id="logout-btn" class="text-sm text-gray-500 underline mt-2">ë¡œê·¸ì•„ì›ƒ</button>
    </header>

    <!-- Todayâ€™s Page -->
    <section class="border-t border-gray-300 pt-6">
      <h2 class="text-2xl font-semibold mb-2">ğŸ“… Todayâ€™s Page</h2>
      <textarea id="today-text" placeholder="ì˜¤ëŠ˜ì˜ ê¸°ë¡ì„ ì ì–´ì£¼ì„¸ìš”..."
        class="w-full border px-3 py-2 rounded focus:outline-none focus:ring-1 focus:ring-gray-400"></textarea>
      <button id="today-save" class="bg-black text-white px-4 py-2 rounded mt-2 hover:bg-gray-800">ì €ì¥</button>
    </section>

    <!-- Our Chat Log -->
    <section class="border-t border-gray-300 pt-6">
      <h2 class="text-2xl font-semibold mb-2">ğŸ’¬ Our Chat Log</h2>
      <div id="chat-box" class="bg-gray-50 p-4 rounded text-sm h-64 overflow-y-auto flex flex-col-reverse space-y-2 space-y-reverse">
        <p class="text-gray-500 text-center">ì•„ì§ ëŒ€í™”ê°€ ì—†ìŠµë‹ˆë‹¤ ğŸ’¬</p>
      </div>
      <input id="chat-message" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
        class="border w-full px-3 py-2 rounded focus:outline-none focus:ring-1 focus:ring-gray-400 mt-3" />
      <button id="send-btn" class="bg-black text-white px-4 py-2 rounded w-full mt-2 hover:bg-gray-800">ë³´ë‚´ê¸°</button>
    </section>

    <!-- Anniversary -->
    <section class="border-t border-gray-300 pt-6">
      <h2 class="text-2xl font-semibold mb-2">ğŸ’• Anniversary</h2>
      <p class="text-gray-700 mb-4">ìš°ë¦¬ëŠ” <strong id="day-count" class="text-black"></strong>ì§¸ì…ë‹ˆë‹¤.</p>
      <table class="w-full text-left border-collapse">
        <thead class="border-b border-gray-300">
          <tr><th class="py-2">ì´ë²¤íŠ¸</th><th class="py-2">ë‚ ì§œ</th><th class="py-2">ë‚¨ì€ ê¸°ê°„</th></tr>
        </thead>
        <tbody id="anniversary-table"></tbody>
      </table>
    </section>

    <!-- Quotes -->
    <section class="border-t border-gray-300 pt-6">
      <h2 class="text-2xl font-semibold mb-2">âœ‰ï¸ Quotes & Letters</h2>
      <div class="space-y-3 text-gray-700">
        <p>ğŸ–¤ â€œì˜¤ëŠ˜ë„ í•¨ê»˜ë¼ì„œ ê³ ë§ˆì›Œ.â€</p>
        <p>ğŸŒ™ â€œë„ˆì™€ ìˆëŠ” ì§€ê¸ˆì´ ì œì¼ ì¢‹ì•„.â€</p>
        <p>ğŸ•¯ï¸ â€œì‚¬ì†Œí•œ ìˆœê°„ë“¤ì´ ê°€ì¥ ë¹›ë‚˜.â€</p>
      </div>
    </section>
  </main>
</body>
</html>
