<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Couple Diary</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Pretendard', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #fffaf9;
      color: #333;
      overflow: hidden;
      transition: background 0.5s ease;
    }

    /* ===== Î°úÍ∑∏Ïù∏ ÌôîÎ©¥ ===== */
    .login-container {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      animation: fadeIn 1.2s ease forwards;
    }

    h1 {
      font-size: 2.2rem;
      color: #ff847c;
      margin-bottom: 20px;
    }

    .heart {
      font-size: 3rem;
      animation: beat 1s infinite;
    }

    @keyframes beat {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }

    .login-input {
      margin-top: 30px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    input[type="text"] {
      padding: 10px 15px;
      border-radius: 10px;
      border: 1px solid #ffd8d2;
      font-size: 14px;
      outline: none;
      width: 200px;
      margin-bottom: 10px;
      text-align: center;
    }

    button {
      background: #ff847c;
      border: none;
      color: #fff;
      padding: 10px 20px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s ease;
    }

    button:hover {
      background: #ff6f66;
    }

    /* ===== ÎåÄÏãúÎ≥¥Îìú ===== */
    header {
      width: 100%;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      padding: 10px 30px;
      font-size: 14px;
      color: #555;
      opacity: 0;
      animation: fadeIn 1.2s ease forwards;
      animation-delay: 0.5s;
    }

    .logout-btn {
      background: none;
      border: none;
      color: #555;
      cursor: pointer;
      font-size: 14px;
      margin-left: 10px;
      transition: color 0.2s ease;
    }

    .logout-btn:hover { color: #ff847c; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .dashboard {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      width: 90%;
      max-width: 1200px;
      gap: 20px;
      margin: 20px auto;
      opacity: 0;
      animation: fadeIn 1.5s ease forwards;
      animation-delay: 0.6s;
    }

    .section {
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      padding: 20px;
      display: flex;
      flex-direction: column;
      height: 70vh;
      overflow-y: auto;
    }

    .section h2 {
      margin-top: 0;
      font-size: 18px;
      color: #ff847c;
      text-align: center;
      border-bottom: 1px solid #ffe0db;
      padding-bottom: 10px;
    }

    .entry {
      background: #fff2ef;
      border-radius: 10px;
      padding: 10px 15px;
      margin: 10px 0;
    }

    .entry .meta {
      font-size: 12px;
      color: #777;
      margin-bottom: 5px;
    }

    .entry p {
      margin: 0;
      font-size: 14px;
      color: #333;
      word-wrap: break-word;
    }

    textarea {
      width: 100%;
      border: 1px solid #ffd8d2;
      border-radius: 10px;
      padding: 10px;
      font-size: 14px;
      resize: none;
      margin-top: auto;
    }

    button.send-btn {
      background: #ff847c;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 10px;
      cursor: pointer;
      align-self: flex-end;
      margin-top: 10px;
      font-size: 13px;
    }

    button.send-btn:hover { background: #ff6f66; }

    .photo-section img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 16px;
    }

    .playlist {
      grid-column: 1 / span 3;
      background: #fff;
      border-radius: 16px;
      padding: 20px;
      margin-top: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      animation: fadeIn 1.4s ease forwards;
      animation-delay: 1.2s;
    }

    .playlist h2 {
      color: #ff847c;
      font-size: 16px;
      margin-bottom: 10px;
      text-align: center;
    }

    .playlist-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
    }

    .playlist-card {
      background: #fff2ef;
      border-radius: 12px;
      padding: 10px;
      text-align: center;
      font-size: 13px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    iframe {
      width: 100%;
      border-radius: 10px;
      height: 100px;
    }

    @media (max-width: 768px) {
      .dashboard { grid-template-columns: 1fr; }
      .section { height: auto; }
      .playlist-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <!-- Î°úÍ∑∏Ïù∏ ÌôîÎ©¥ -->
  <div class="login-container" id="loginPage">
    <h1>Couple Diary</h1>
    <div class="heart">ü§ç</div>
    <div class="login-input">
      <input type="text" id="loginId" placeholder="IDÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî (SM0710 / CY07010)" />
      <button id="loginBtn">Login</button>
    </div>
  </div>

  <!-- ÎåÄÏãúÎ≥¥Îìú -->
  <div id="dashboardPage" style="display:none;">
    <header>
      <span id="userDisplay"></span>
      <button class="logout-btn" id="logoutBtn">Î°úÍ∑∏ÏïÑÏõÉ</button>
    </header>

    <div class="dashboard" id="dashboard">
      <div class="section" id="todayLogs">
        <h2>Ïò§ÎäòÏùò Í∏∞Î°ù</h2>
        <div id="todayLogList"></div>
        <textarea id="todayInput" placeholder="Ïò§ÎäòÏùò Í∏∞Î°ùÏùÑ ÎÇ®Í≤®Î≥¥ÏÑ∏Ïöî..."></textarea>
        <button class="send-btn" id="todaySend">Îì±Î°ù</button>
      </div>

      <div class="section photo-section">
        <h2>ÏÇ¨ÏßÑ</h2>
        <img id="photoDisplay" src="https://via.placeholder.com/400x400?text=ÏÇ¨ÏßÑÏùÑ+ÏóÖÎ°úÎìúÌïòÏÑ∏Ïöî" alt="photo" />
        <input type="file" id="photoUpload" accept="image/*" />
      </div>

      <div class="section" id="chatLogs">
        <h2>ÎåÄÌôî</h2>
        <div id="chatList"></div>
        <textarea id="chatInput" placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."></textarea>
        <button class="send-btn" id="chatSend">Î≥¥ÎÇ¥Í∏∞</button>
      </div>

      <div class="playlist">
        <h2>ÌîåÎ†àÏù¥Î¶¨Ïä§Ìä∏</h2>
        <div class="playlist-grid" id="playlistGrid"></div>
        <input type="text" id="playlistInput" placeholder="YouTube ÎßÅÌÅ¨Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî" style="width:80%; border-radius:8px; padding:6px; border:1px solid #ffd8d2;">
        <button class="send-btn" id="playlistAdd">Ï∂îÍ∞Ä</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, orderBy, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBw9CXG7BMyCQ3qMWFaXPfi_gS_HIiXIOA",
      authDomain: "couple-diary-42d49.firebaseapp.com",
      projectId: "couple-diary-42d49",
      storageBucket: "couple-diary-42d49.firebasestorage.app",
      messagingSenderId: "162533479109",
      appId: "1:162533479109:web:a67f8d213bddafc66fd6ac",
      measurementId: "G-2N8R9H692D"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const loginPage = document.getElementById("loginPage");
    const dashboardPage = document.getElementById("dashboardPage");
    const loginBtn = document.getElementById("loginBtn");
    const loginId = document.getElementById("loginId");

    const userDisplay = document.getElementById("userDisplay");
    const logoutBtn = document.getElementById("logoutBtn");

    let userName = localStorage.getItem("userName");

    function showDashboard() {
      loginPage.style.display = "none";
      dashboardPage.style.display = "block";
    }

    if (userName) {
      showDashboard();
      userDisplay.textContent = `${userName === 'SM0710' ? 'ÍπÄÏÜîÏùå üñ§' : 'ÏµúÏöîÏõê üíô'}`;
    }

    loginBtn.addEventListener("click", () => {
      const input = loginId.value.trim();
      if (input === "SM0710" || input === "CY07010") {
        userName = input;
        localStorage.setItem("userName", input);
        userDisplay.textContent = `${userName === 'SM0710' ? 'ÍπÄÏÜîÏùå üñ§' : 'ÏµúÏöîÏõê üíô'}`;
        showDashboard();
      } else {
        alert("ÏïÑÏù¥ÎîîÎ•º ÌôïÏù∏ÌïòÏÑ∏Ïöî.");
      }
    });

    logoutBtn.addEventListener("click", () => {
      localStorage.removeItem("userName");
      location.reload();
    });

    function formatDate(ts) {
      const d = ts?.toDate ? ts.toDate() : new Date(ts);
      return `${d.getFullYear()}.${String(d.getMonth()+1).padStart(2,'0')}.${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    }

    // === Ìà¨Îç∞Ïù¥ Î°úÍ∑∏ ===
    const todayRef = collection(db, "todayLogs");
    const todayList = document.getElementById("todayLogList");
    const todayInput = document.getElementById("todayInput");
    const todaySend = document.getElementById("todaySend");

    onSnapshot(query(todayRef, orderBy("timestamp", "desc")), (snap) => {
      todayList.innerHTML = "";
      snap.forEach((doc) => {
        const data = doc.data();
        todayList.innerHTML += `
          <div class="entry">
            <div class="meta">${data.updateBy || 'ÏùµÎ™Ö'} ¬∑ ${formatDate(data.timestamp)}</div>
            <p>${data.text}</p>
          </div>`;
      });
    });

    todaySend.onclick = async () => {
      const text = todayInput.value.trim();
      if (!text) return;
      await addDoc(todayRef, { text, updateBy: userName, timestamp: serverTimestamp() });
      todayInput.value = "";
    };

    todayInput.addEventListener("keypress", e => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        todaySend.click();
      }
    });

    // === Ï±ÑÌåÖ ===
    const chatRef = collection(db, "chat");
    const chatList = document.getElementById("chatList");
    const chatInput = document.getElementById("chatInput");
    const chatSend = document.getElementById("chatSend");

    onSnapshot(query(chatRef, orderBy("timestamp", "asc")), (snap) => {
      chatList.innerHTML = "";
      snap.forEach((doc) => {
        const data = doc.data();
        chatList.innerHTML += `
          <div class="entry">
            <div class="meta">${data.name || 'ÏùµÎ™Ö'} ¬∑ ${formatDate(data.timestamp)}</div>
            <p>${data.message}</p>
          </div>`;
      });
      chatList.scrollTop = chatList.scrollHeight;
    });

    chatSend.onclick = async () => {
      const text = chatInput.value.trim();
      if (!text) return;
      await addDoc(chatRef, { message: text, name: userName, timestamp: serverTimestamp() });
      chatInput.value = "";
    };

    chatInput.addEventListener("keypress", e => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        chatSend.click();
      }
    });

    // === ÏÇ¨ÏßÑ ===
    const photoUpload = document.getElementById("photoUpload");
    const photoDisplay = document.getElementById("photoDisplay");

    photoUpload.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const storageRef = ref(storage, `photos/${file.name}`);
      await uploadBytes(storageRef, file);
      const url = await getDownloadURL(storageRef);
      await addDoc(collection(db, "photo"), { url, name: userName, timestamp: serverTimestamp() });
    });

    onSnapshot(query(collection(db, "photo"), orderBy("timestamp", "desc")), (snap) => {
      const latest = snap.docs[0];
      if (latest) photoDisplay.src = latest.data().url;
    });

    // === ÌîåÎ†àÏù¥Î¶¨Ïä§Ìä∏ ===
    const playlistRef = collection(db, "playlist");
    const playlistGrid = document.getElementById("playlistGrid");
    const playlistInput = document.getElementById("playlistInput");
    const playlistAdd = document.getElementById("playlistAdd");

    onSnapshot(query(playlistRef, orderBy("timestamp", "desc")), (snap) => {
      playlistGrid.innerHTML = "";
      snap.forEach((doc) => {
        const data = doc.data();
        const match = data.url.match(/(?:v=|be\/)([a-zA-Z0-9_-]{11})/);
        const videoId = match ? match[1] : "";
        playlistGrid.innerHTML += `
          <div class="playlist-card">
            <iframe src="https://www.youtube.com/embed/${videoId}" allowfullscreen></iframe>
            <p>Ï∂îÍ∞Ä: ${data.addeBy || userName}</p>
          </div>`;
      });
    });

    playlistAdd.onclick = async () => {
      const url = playlistInput.value.trim();
      if (!url) return;
      await addDoc(playlistRef, { url, addeBy: userName, timestamp: serverTimestamp() });
      playlistInput.value = "";
    };
  </script>
</body>
</html>
