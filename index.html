<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Couple Space — Final</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --cute-1:#fff7f6;
      --accent-1:#f7c6b7;
      --accent-2:#f9a5a2;
      --text:#5b4a4a;
      --muted:#a38888;
      --panel:#fffdfa;
    }
    html,body{height:100%;margin:0;font-family:"Pretendard","Noto Sans KR",system-ui;}
    body{
      background:linear-gradient(145deg,#fff9f8,#fefefe);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
    }

    /* container */
    .wrap{max-width:1200px;margin:28px auto;padding:0 16px;}

    /* header area */
    .topbar{display:flex;justify-content:flex-end;align-items:center;gap:12px;margin-bottom:14px}
    .user-badge{font-weight:600;color:var(--text)}

    /* panels */
    .panel{
      background:var(--panel);
      border-radius:18px;
      padding:14px;
      box-shadow:5px 5px 12px rgba(0,0,0,0.05), -4px -4px 8px #fff;
      border:1px solid rgba(0,0,0,0.03);
    }

    /* layout 3 col */
    .cols{display:flex;gap:16px}
    .col{flex:1; display:flex; flex-direction:column; gap:12px}
    .col.center{flex:1.1; align-items:center;} /* center slightly larger */

    /* cute UI */
    .btn{
      background:linear-gradient(135deg,var(--accent-1),var(--accent-2));
      color:#fff; font-weight:700; border-radius:999px;
      padding:8px 14px; font-size:14px; box-shadow:2px 2px 6px rgba(247,175,160,0.35);
      border:none; cursor:pointer; white-space:nowrap;
    }
    .btn:active{transform:scale(.98)}
    .small{
      background:#f9c2b9;color:#fff;border-radius:8px;padding:6px 8px;border:none;cursor:pointer;white-space:nowrap;
    }
    input, textarea {
      border: none; background:#fff3f1; border-radius:12px; padding:10px;
      box-shadow:inset 2px 2px 6px #e7d6d2, inset -2px -2px 6px #fff; resize:vertical;
      font-size:14px; color:var(--text);
    }
    textarea { min-height:90px; max-height:220px; }

    .item { background:#fff8f7;border-radius:12px;padding:10px;border:1px solid rgba(0,0,0,0.02)}
    .meta{font-size:12px;color:var(--muted);margin-top:6px}

    /* chat bubble */
    .chat-wrap{display:flex;flex-direction:column;gap:8px}
    .bubble{
      max-width:78%;
      padding:8px 10px;
      border-radius:14px;
      box-shadow:2px 2px 6px rgba(0,0,0,0.04), -2px -2px 6px #fff;
      font-size:14px;
      word-break:break-word;
    }
    .bubble.other{ background:#fff0ee; align-self:flex-start; }
    .bubble.me{ background:#ffd2cf; align-self:flex-end; }

    /* photo */
    .photo-box{width:100%;display:flex;flex-direction:column;align-items:center;gap:8px}
    .photo-box img{width:100%;height:auto;max-height:520px;border-radius:12px;object-fit:cover;background:#fff}

    /* music grid */
    .music-grid{display:grid;grid-template-columns:repeat(1,1fr);gap:12px}
    @media(min-width:640px){ .music-grid{grid-template-columns:repeat(2,1fr)} }
    @media(min-width:1024px){ .music-grid{grid-template-columns:repeat(3,1fr)} }

    /* responsive */
    @media(max-width:960px){
      .cols{flex-direction:column}
      .col.center{order:2}
    }

    /* login */
    #login-screen{height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(145deg,#fff0ef,#ffe5e3)}
    .login-card{width:100%;max-width:420px;padding:24px;border-radius:18px;background:var(--panel);box-shadow:6px 6px 14px rgba(0,0,0,0.06);text-align:center}
    .login-h1{font-size:20px;color:#e38884;margin-bottom:10px;font-weight:700}
  </style>
</head>
<body>

  <!-- LOGIN -->
  <div id="login-screen">
    <div class="login-card">
      <div class="login-h1">🍑 Couple Space</div>
      <input id="login-id" placeholder="ID 입력 (SM0710 / CY0710)" style="margin-bottom:12px;text-align:center;"/>
      <div>
        <button id="login-btn" class="btn" style="width:100%;">로그인</button>
      </div>
      <div style="margin-top:10px;font-size:13px;color:var(--muted)">SM0710 = 김솔음 / CY0710 = 최요원</div>
    </div>
  </div>

  <!-- MAIN WRAP -->
  <div class="wrap" id="main-wrap" style="display:none;">

    <div class="topbar">
      <div id="user-badge" class="user-badge"></div>
      <button id="logout" class="small">로그아웃</button>
    </div>

    <div class="cols" role="main">
      <!-- LEFT: Today -->
      <div class="col left-col">
        <div class="panel">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div style="font-weight:700">📖 Today Log</div>
          </div>
          <textarea id="today-input" placeholder="오늘 하루를 기록해봐요..."></textarea>
          <div style="margin-top:10px;display:flex;gap:8px">
            <button id="today-save" class="btn" style="flex:1">저장</button>
          </div>
        </div>

        <div id="today-list" style="margin-top:12px;display:flex;flex-direction:column;gap:10px"></div>
      </div>

      <!-- CENTER: Photo -->
      <div class="col center center-col">
        <div class="panel photo-panel" style="width:100%;display:flex;flex-direction:column;gap:12px;align-items:stretch">
          <div style="font-weight:700">📸 Couple Photo</div>
          <div class="photo-box">
            <img id="photo-display" alt="couple photo" src="" />
            <input id="photo-upload" type="file" accept="image/*"/>
            <div class="meta">사진을 업로드하면 저장되고 모두가 볼 수 있어요.</div>
          </div>
        </div>
      </div>

      <!-- RIGHT: Chat -->
      <div class="col right-col">
        <div class="panel" style="display:flex;flex-direction:column;height:100%">
          <div style="font-weight:700;margin-bottom:8px">💬 Chat Log</div>
          <div id="chat-box" style="flex:1;overflow:auto;padding:6px;display:flex;flex-direction:column;gap:8px;height:420px"></div>

          <div style="display:flex;gap:8px;margin-top:10px;align-items:center">
            <input id="chat-input" placeholder="메시지를 입력하세요" style="flex:1"/>
            <button id="chat-send" class="btn">보내기</button>
          </div>
        </div>

        <div style="height:12px"></div>

        <!-- Playlist under chat on right column -->
        <div class="panel" style="margin-top:8px">
          <div style="font-weight:700;margin-bottom:8px">🎵 Playlist</div>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="music-link" placeholder="YouTube 링크 입력" style="flex:1"/>
            <button id="music-add" class="btn">추가</button>
          </div>
          <div id="music-list" class="music-grid" style="margin-top:12px"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase + App Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore, collection, addDoc, onSnapshot, query, orderBy,
      serverTimestamp, updateDoc, deleteDoc, doc, getDoc
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

    // --- Firebase config (from you)
    const firebaseConfig = {
      apiKey: "AIzaSyBw9CXG7BMyCQ3qMWFaXPfi_gS_HIiXIOA",
      authDomain: "couple-diary-42d49.firebaseapp.com",
      projectId: "couple-diary-42d49",
      storageBucket: "couple-diary-42d49.firebasestorage.app",
      messagingSenderId: "162533479109",
      appId: "1:162533479109:web:a67f8d213bddafc66fd6ac",
      measurementId: "G-2N8R9H692D"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // DOM
    const loginScreen = document.getElementById("login-screen");
    const mainWrap = document.getElementById("main-wrap");
    const loginBtn = document.getElementById("login-btn");
    const loginId = document.getElementById("login-id");
    const userBadge = document.getElementById("user-badge");
    const logoutBtn = document.getElementById("logout");

    const todayInput = document.getElementById("today-input");
    const todaySave = document.getElementById("today-save");
    const todayList = document.getElementById("today-list");

    const photoUpload = document.getElementById("photo-upload");
    const photoDisplay = document.getElementById("photo-display");

    const chatInput = document.getElementById("chat-input");
    const chatSend = document.getElementById("chat-send");
    const chatBox = document.getElementById("chat-box");

    const musicLink = document.getElementById("music-link");
    const musicAdd = document.getElementById("music-add");
    const musicList = document.getElementById("music-list");

    let currentUser = null;

    // format timestamp to YYYY.MM.DD HH:MM
    function fmt(ts){
      if(!ts) return "";
      const d = ts.toDate();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      return `${y}.${m}.${dd} ${hh}:${mm}`;
    }

    // LOGIN
    loginBtn.addEventListener("click", ()=> {
      const id = loginId.value.trim();
      if(id === "SM0710") currentUser = { name:"김솔음", heart:"🖤" };
      else if(id === "CY0710") currentUser = { name:"최요원", heart:"💙" };
      else { alert("아이디가 잘못되었습니다."); return; }

      // show main
      loginScreen.style.display = "none";
      mainWrap.style.display = "block";
      userBadge.textContent = `${currentUser.heart} ${currentUser.name}`;

      // load all realtime data
      subscribeAll();
    });

    logoutBtn.addEventListener("click", ()=> location.reload());

    // --------- SUBSCRIPTIONS ----------
    let unsubToday = null, unsubChat = null, unsubPhoto = null, unsubMusic = null;
    function subscribeAll(){
      // Today logs (desc)
      const qToday = query(collection(db,"todayLogs"), orderBy("timestamp","desc"));
      unsubToday = onSnapshot(qToday, snap => {
        todayList.innerHTML = "";
        snap.forEach(docSnap => {
          const d = docSnap.data();
          const id = docSnap.id;
          const author = d.updateBy || "익명";
          const el = document.createElement("div");
          el.className = "item";
          el.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px">
              <div><strong>${escapeHtml(author)}</strong> — ${escapeHtml(d.text)}</div>
              ${author === currentUser.name ? `<div style="display:flex;flex-direction:column;gap:6px">
                <button class="small edit-today" data-id="${id}">수정</button>
                <button class="small del-today" data-id="${id}">삭제</button>
              </div>` : ""}
            </div>
            <div class="meta">${fmt(d.timestamp)}</div>
          `;
          todayList.appendChild(el);
        });

        // attach events
        todayList.querySelectorAll(".del-today").forEach(btn=>{
          btn.onclick = async (e)=>{
            if(confirm("정말 삭제할까요?")) await deleteDoc(doc(db,"todayLogs", e.target.dataset.id));
          };
        });
        todayList.querySelectorAll(".edit-today").forEach(btn=>{
          btn.onclick = async (e)=>{
            const id = e.target.dataset.id;
            const ref = doc(db,"todayLogs",id);
            const snap = await getDoc(ref);
            const prev = snap.exists() ? snap.data().text : "";
            const next = prompt("수정할 내용을 입력하세요", prev);
            if(next !== null) await updateDoc(ref, { text: next, updateBy: currentUser.name, timestamp: serverTimestamp() });
          };
        });
      });

      // Chat (asc: older->newer so latest at bottom)
      const qChat = query(collection(db,"chat"), orderBy("timestamp","asc"));
      unsubChat = onSnapshot(qChat, snap => {
        chatBox.innerHTML = "";
        snap.forEach(docSnap => {
          const d = docSnap.data();
          const who = escapeHtml(d.name||"");
          const msg = escapeHtml(d.message||"");
          const bubble = document.createElement("div");
          bubble.className = "bubble " + (d.name === currentUser.name ? "me" : "other");
          bubble.innerHTML = `${msg}<div class="meta">${who} · ${fmt(d.timestamp)}</div>`;
          // wrapper alignment
          const wrapper = document.createElement("div");
          wrapper.style.display = "flex";
          wrapper.style.justifyContent = (d.name === currentUser.name ? "flex-end" : "flex-start");
          wrapper.appendChild(bubble);
          chatBox.appendChild(wrapper);
        });
        // scroll to bottom
        chatBox.scrollTop = chatBox.scrollHeight;
      });

      // Photo (latest first) -> show first doc's url
      const qPhoto = query(collection(db,"photo"), orderBy("timestamp","desc"));
      unsubPhoto = onSnapshot(qPhoto, snap => {
        if(!snap.empty){
          const url = snap.docs[0].data().url;
          if(url) photoDisplay.src = url;
        } else {
          photoDisplay.src = ""; // nothing
        }
      });

      // Music
      const qMusic = query(collection(db,"playlist"), orderBy("timestamp","desc"));
      unsubMusic = onSnapshot(qMusic, snap => {
        musicList.innerHTML = "";
        snap.forEach(docSnap => {
          const d = docSnap.data();
          const id = docSnap.id;
          const urlRaw = d.url || "";
          // normalize to embed if youtube url
          let embed = urlRaw;
          try {
            const u = new URL(urlRaw);
            if(u.hostname.includes("youtube")) {
              // get v param or short id
              const vid = u.searchParams.get("v");
              if(vid) embed = `https://www.youtube.com/embed/${vid}`;
              else {
                // check if path contains /embed/
                if(u.pathname.includes("/embed/")) embed = urlRaw;
              }
            }
          } catch(e){}
          const card = document.createElement("div");
          card.className = "item";
          card.innerHTML = `
            <div style="border-radius:10px;overflow:hidden">
              <iframe width="100%" height="160" src="${embed}" frameborder="0" allowfullscreen></iframe>
            </div>
            <div class="meta" style="margin-top:8px">${escapeHtml(d.addedBy||"")} · ${fmt(d.timestamp)}</div>
            ${d.addedBy === currentUser.name ? `<div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px">
              <button class="small edit-music" data-id="${id}">수정</button>
              <button class="small del-music" data-id="${id}">삭제</button>
            </div>` : ""}
          `;
          musicList.appendChild(card);
        });

        // attach events
        musicList.querySelectorAll(".del-music").forEach(btn=>{
          btn.onclick = async e => {
            if(confirm("정말 삭제할까요?")) await deleteDoc(doc(db,"playlist", e.target.dataset.id));
          };
        });
        musicList.querySelectorAll(".edit-music").forEach(btn=>{
          btn.onclick = async e => {
            const id = e.target.dataset.id;
            const ref = doc(db,"playlist",id);
            const snap = await getDoc(ref);
            const prev = snap.exists() ? snap.data().url : "";
            const next = prompt("새 YouTube 링크를 입력하세요", prev);
            if(next !== null) await updateDoc(ref, { url: next, addedBy: currentUser.name, timestamp: serverTimestamp() });
          };
        });
      });
    }

    // CREATE operations
    document.getElementById("today-save").addEventListener("click", async ()=>{
      const text = todayInput.value.trim();
      if(!text) return alert("내용을 입력해 주세요.");
      await addDoc(collection(db,"todayLogs"), { text, updateBy: currentUser.name, timestamp: serverTimestamp() });
      todayInput.value = "";
    });

    chatSend.addEventListener("click", async ()=>{
      const msg = chatInput.value.trim();
      if(!msg) return;
      await addDoc(collection(db,"chat"), { message: msg, name: currentUser.name, heart: currentUser.heart, timestamp: serverTimestamp() });
      chatInput.value = "";
    });
    chatInput.addEventListener("keypress", e => { if(e.key === "Enter") chatSend.click(); });

    musicAdd.addEventListener("click", async ()=>{
      const url = musicLink.value.trim();
      if(!url) return alert("링크를 입력하세요.");
      await addDoc(collection(db,"playlist"), { url, addedBy: currentUser.name, timestamp: serverTimestamp() });
      musicLink.value = "";
    });

    // photo upload -> storage + write to firestore
    photoUpload.addEventListener("change", async (e)=>{
      const file = e.target.files?.[0];
      if(!file) return;
      const path = `photos/${Date.now()}_${file.name}`;
      const storageRef = ref(storage, path);
      await uploadBytes(storageRef, file);
      const url = await getDownloadURL(storageRef);
      await addDoc(collection(db,"photo"), { url, name: currentUser.name, timestamp: serverTimestamp() });
      // photoDisplay will update via onSnapshot
    });

    // small helper: escape HTML
    function escapeHtml(str){
      if(!str) return "";
      return String(str).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
    }

    // small: getDoc imported earlier is used, ensure to import in header? We used getDoc in code - add import:
    // (Note: getDoc is already imported earlier in list; if not, browser will show error — but above import includes getDoc.)
    // (Everything required already imported at top of module.)

    // End
  </script>
</body>
</html>
