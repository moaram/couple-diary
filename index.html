<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Couple Diary</title>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, onSnapshot, updateDoc, deleteDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBw9CXG7BMyCQ3qMWFaXPfi_gS_HIiXIOA",
      authDomain: "couple-diary-42d49.firebaseapp.com",
      projectId: "couple-diary-42d49",
      storageBucket: "couple-diary-42d49.firebasestorage.app",
      messagingSenderId: "162533479109",
      appId: "1:162533479109:web:a67f8d213bddafc66fd6ac",
      measurementId: "G-2N8R9H692D"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    const loginContainer = document.getElementById("login-container");
    const dashboard = document.getElementById("dashboard");
    const loginForm = document.getElementById("login-form");
    const logoutBtn = document.getElementById("logout-btn");
    const userNameDisplay = document.getElementById("user-name");

    const todayLogsRef = collection(db, "todayLogs");
    const chatRef = collection(db, "chat");
    const photoRef = collection(db, "photo");
    const playlistRef = collection(db, "playlist");

    // ÎÇ†Ïßú ÌòïÏãù Ìï®Ïàò
    function formatDate(ts) {
      if (!ts) return "";
      const d = ts.toDate();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      const h = String(d.getHours()).padStart(2, "0");
      const min = String(d.getMinutes()).padStart(2, "0");
      return `${y}.${m}.${day} ${h}:${min}`;
    }

    // Î°úÍ∑∏Ïù∏
    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const id = document.getElementById("email").value.trim();
      const email = id + "@example.com";
      const password = "111111"; // ÎÇ¥Î∂Ä ÌÖåÏä§Ìä∏Ïö©
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (err) {
        alert("Î°úÍ∑∏Ïù∏ Ïã§Ìå®: " + err.message);
      }
    });

    logoutBtn.addEventListener("click", () => signOut(auth));

    onAuthStateChanged(auth, (user) => {
      if (user) {
        loginContainer.style.display = "none";
        dashboard.style.display = "block";
        userNameDisplay.textContent = user.email.split("@")[0];
        loadAllData();
      } else {
        loginContainer.style.display = "flex";
        dashboard.style.display = "none";
      }
    });

    // ======== DATA LOAD =========
    function loadAllData() {
      loadTodayLogs();
      loadChat();
      loadPhotos();
      loadPlaylist();
    }

    // TODAY LOGS
    function loadTodayLogs() {
      const q = query(todayLogsRef, orderBy("timestamp", "asc"));
      onSnapshot(q, (snapshot) => {
        const container = document.getElementById("today-logs");
        container.innerHTML = "";
        snapshot.forEach((docSnap) => {
          const log = docSnap.data();
          const div = document.createElement("div");
          div.className = "card";
          div.innerHTML = `
            <p class="meta">${log.date}</p>
            <p>${log.text}</p>
            <p class="author">- ${log.updatedBy}</p>
            <p class="meta">${formatDate(log.timestamp)}</p>
            <div class="actions">
              <button onclick="editToday('${docSnap.id}', '${log.text}')">‚úèÔ∏è</button>
              <button onclick="deleteToday('${docSnap.id}')">üóëÔ∏è</button>
            </div>
          `;
          container.appendChild(div);
        });
      });
    }

    window.editToday = async (id, text) => {
      const newText = prompt("ÏàòÏ†ïÌï† ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:", text);
      if (newText) {
        const docRef = doc(db, "todayLogs", id);
        await updateDoc(docRef, { text: newText });
      }
    };

    window.deleteToday = async (id) => {
      if (confirm("Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) {
        await deleteDoc(doc(db, "todayLogs", id));
      }
    };

    // CHAT
    function loadChat() {
      const q = query(chatRef, orderBy("timestamp", "asc"));
      onSnapshot(q, (snapshot) => {
        const container = document.getElementById("chat-logs");
        container.innerHTML = "";
        snapshot.forEach((docSnap) => {
          const c = docSnap.data();
          const div = document.createElement("div");
          div.className = c.name === auth.currentUser.email.split("@")[0] ? "chat-bubble me" : "chat-bubble you";
          div.innerHTML = `<span class="msg">${c.message}</span><span class="meta">${c.name}</span>`;
          container.appendChild(div);
        });
        container.scrollTop = container.scrollHeight;
      });
    }

    document.getElementById("chat-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const input = document.getElementById("chat-input");
      const msg = input.value.trim();
      if (msg) {
        await addDoc(chatRef, {
          name: auth.currentUser.email.split("@")[0],
          message: msg,
          timestamp: new Date()
        });
        input.value = "";
      }
    });

    // PHOTO
    function loadPhotos() {
      const q = query(photoRef, orderBy("timestamp", "desc"));
      onSnapshot(q, (snapshot) => {
        const container = document.getElementById("photo-section");
        container.innerHTML = "";
        snapshot.forEach((docSnap) => {
          const p = docSnap.data();
          const img = document.createElement("img");
          img.src = p.url;
          img.className = "photo-item";
          container.appendChild(img);
        });
      });
    }

    document.getElementById("photo-upload").addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const fileRef = ref(storage, `photos/${Date.now()}_${file.name}`);
      await uploadBytes(fileRef, file);
      const url = await getDownloadURL(fileRef);
      await addDoc(photoRef, {
        name: auth.currentUser.email.split("@")[0],
        url,
        timestamp: new Date()
      });
    });

    // PLAYLIST
    function loadPlaylist() {
      const q = query(playlistRef, orderBy("timestamp", "desc"));
      onSnapshot(q, (snapshot) => {
        const container = document.getElementById("playlist");
        container.innerHTML = "";
        snapshot.forEach((docSnap) => {
          const p = docSnap.data();
          const div = document.createElement("div");
          div.className = "playlist-card";
          div.innerHTML = `
            <a href="${p.url}" target="_blank">${p.url}</a>
            <div class="actions">
              <button onclick="editPlaylist('${docSnap.id}', '${p.url}')">‚úèÔ∏è</button>
              <button onclick="deletePlaylist('${docSnap.id}')">üóëÔ∏è</button>
            </div>
          `;
          container.appendChild(div);
        });
      });
    }

    window.editPlaylist = async (id, url) => {
      const newUrl = prompt("ÏàòÏ†ïÌï† ÏùåÏïÖ URL:", url);
      if (newUrl) await updateDoc(doc(db, "playlist", id), { url: newUrl });
    };

    window.deletePlaylist = async (id) => {
      if (confirm("Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) await deleteDoc(doc(db, "playlist", id));
    };
  </script>

  <style>
    body {
      margin: 0; font-family: "Pretendard", sans-serif;
      background: linear-gradient(135deg, #e5ebf1, #f5f7f9);
      color: #333;
    }
    #login-container {
      display: flex; justify-content: center; align-items: center;
      height: 100vh; background: #f0f2f5;
    }
    #login-box {
      background: #fff;
      padding: 30px 40px;
      border-radius: 20px;
      box-shadow: 8px 8px 16px #d1d9e6, -8px -8px 16px #ffffff;
      text-align: center;
    }
    input, button {
      border: none; outline: none; border-radius: 12px;
    }
    input {
      width: 80%; margin: 10px 0; padding: 10px;
      box-shadow: inset 3px 3px 6px #d1d9e6, inset -3px -3px 6px #ffffff;
      text-align: center;
    }
    button {
      padding: 8px 14px; background: #a5b4c7; color: white;
      box-shadow: 3px 3px 8px #c8d0e0, -3px -3px 8px #ffffff;
      cursor: pointer;
    }
    #dashboard { display: none; padding: 20px; text-align: center; }
    #top-bar { display: flex; justify-content: flex-end; margin-bottom: 15px; align-items: center; }
    #user-name { margin-right: 10px; color: #5f7289; font-weight: 600; }

    .grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 30px; }
    .section {
      background: #f5f7fa; border-radius: 20px; padding: 15px;
      box-shadow: 5px 5px 15px #c8d0e0, -5px -5px 15px #ffffff;
      min-height: 400px; display: flex; flex-direction: column;
    }
    .card, .playlist-card {
      background: #fff; border-radius: 15px; margin-bottom: 10px; padding: 10px;
      box-shadow: 2px 2px 6px #d1d9e6, -2px -2px 6px #ffffff;
    }
    .chat-bubble {
      padding: 6px 12px; border-radius: 12px; margin: 4px; max-width: 75%;
    }
    .chat-bubble.me { background: #a8c4e6; align-self: flex-end; }
    .chat-bubble.you { background: #e3e8ef; align-self: flex-start; }
    .msg { display: block; }
    .meta { font-size: 12px; color: #777; }
    .author { font-size: 13px; font-style: italic; color: #5e6b7a; }

    #photo-section { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
    .photo-item { width: 100%; border-radius: 15px; object-fit: cover; }

    #playlist { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }

    @media (max-width: 900px) {
      .grid { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div id="login-container">
    <div id="login-box">
      <h2>Î°úÍ∑∏Ïù∏</h2>
      <form id="login-form">
        <input type="text" id="email" placeholder="ÏïÑÏù¥Îîî (SM0710 / CY07010)" required />
        <button type="submit">Î°úÍ∑∏Ïù∏</button>
      </form>
    </div>
  </div>

  <div id="dashboard">
    <div id="top-bar">
      <span id="user-name"></span>
      <button id="logout-btn">Î°úÍ∑∏ÏïÑÏõÉ</button>
    </div>

    <div class="grid">
      <div class="section">
        <h3>Ìà¨Îç∞Ïù¥ Î°úÍ∑∏</h3>
        <div id="today-logs"></div>
      </div>
      <div class="section">
        <h3>ÏÇ¨ÏßÑ</h3>
        <div id="photo-section"></div>
        <input type="file" id="photo-upload" />
      </div>
      <div class="section">
        <h3>Ï±ÑÌåÖ Î°úÍ∑∏</h3>
        <div id="chat-logs" style="overflow-y:auto; flex:1;"></div>
        <form id="chat-form" style="display:flex; gap:8px; margin-top:10px;">
          <input type="text" id="chat-input" placeholder="Î©îÏãúÏßÄ ÏûÖÎ†•" style="flex:1;" />
          <button type="submit">Î≥¥ÎÇ¥Í∏∞</button>
        </form>
      </div>
    </div>

    <div class="section" style="margin-top:20px;">
      <h3>ÌîåÎ†àÏù¥Î¶¨Ïä§Ìä∏</h3>
      <div id="playlist"></div>
      <form id="playlist-form" style="display:flex; gap:8px; margin-top:10px;">
        <input type="text" id="playlist-input" placeholder="ÏùåÏïÖ ÎßÅÌÅ¨ ÏûÖÎ†•" style="flex:1;" />
        <button type="submit">Ï∂îÍ∞Ä</button>
      </form>
    </div>
  </div>
</body>
</html>
